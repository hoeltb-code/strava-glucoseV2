{% extends "base.html" %}
{% block title %}Activit√© ¬∑ {{ activity.name or "Sans titre" }}{% endblock %}

{% block extra_head %}
<style>
  .activity-header-actions {
    display:flex;
    gap:10px;
  }
  .activity-stats-grid {
    display:grid;
    grid-template-columns:repeat(6,1fr);
    gap:12px;
  }
  .activity-layout {
    display:grid;
    grid-template-columns:210px minmax(0,1fr);
    gap:16px;
    align-items:flex-start;
  }
  .activity-sidebar {
    padding:12px;
    font-size:0.9rem;
  }
  .table-responsive {
    width:100%;
    overflow-x:auto;
  }
  .activity-tab {
    display:none;
    margin-bottom:16px;
  }
  .activity-tab.is-active {
    display:block;
  }
  .overview-vam {
    border-top:1px solid #e5e7eb;
  }
  .vam-table th:first-child,
  .vam-table td:first-child {
    width:70px;
    white-space:nowrap;
  }
  .vam-table th:not(:first-child),
  .vam-table td:not(:first-child) {
    width:65px;
    text-align:right;
  }
  @media (max-width: 900px) {
    .activity-stats-grid {
      grid-template-columns:repeat(auto-fit, minmax(140px,1fr));
    }
    .overview-map {
      height:220px;
    }
  }
  @media (max-width: 720px) {
    .activity-header {
      flex-direction:column;
      align-items:flex-start;
      gap:12px;
    }
    .activity-header-actions {
      width:100%;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .activity-layout {
      display:block;
    }
    .activity-sidebar {
      display:none;
    }
    .card h3 {
      font-size:1rem;
    }
  .overview-layout {
    grid-template-columns:1fr !important;
  }
  .overview-layout .overview-divider {
    display:none;
  }
  .overview-map-container {
    padding:12px !important;
  }
    .overview-map {
      height:200px;
    }
    .table-responsive table {
      font-size:0.8rem;
      min-width:100%;
    }
    .activity-tab {
      display:block !important;
    }
  }

  @media (min-width: 721px) {
    .table-responsive table {
      min-width:unset;
    }
    .activity-tab {
      display:none;
    }
    .activity-tab.is-active {
      display:block;
    }
  }
</style>
{% endblock %}

{% block content %}

<!-- ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó -->
<!--   üßç Header utilisateur + actions  -->
<!-- ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù -->
<div class="activity-header" style="
  display:flex; align-items:center; justify-content:space-between;
  padding:16px 0 12px; border-bottom:1px solid var(--border-soft);
  margin-bottom:16px;
">
  <div style="display:flex; align-items:center; gap:14px;">
    <div>
      <div style="font-size:1.1rem; font-weight:600;">
        {{ user.first_name or "" }} {{ user.last_name or "" }}
      </div>
      <div class="muted" style="margin-top:2px;">id={{ user.id }}</div>
    </div>
  </div>

  <div class="activity-header-actions">



    <!-- Bouton danger : Supprimer -->
    <form method="post"
          action="/ui/user/{{ user.id }}/activity/{{ activity.id }}/delete"
          onsubmit="return confirm('Supprimer d√©finitivement ?')">
      <button type="submit"
        style="display:inline-flex; align-items:center; gap:6px;
               padding:10px 16px; font-size:.95rem; font-weight:600; border-radius:2px;
               border:1px solid transparent; background:#0d6efd; color:#fff;
               text-decoration:none; box-shadow:0 6px 16px rgba(13,110,253,.25);
               transition:filter .15s ease, transform .06s ease; cursor:pointer;"
        onmouseover="this.style.filter='brightness(1.08)'"
        onmouseout="this.style.filter='none'"
        onmousedown="this.style.transform='translateY(1px)'"
        onmouseup="this.style.transform='none'">
        üóë Supprimer
      </button>
    </form>

  </div>
</div>

<!-- ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó -->
<!--      üèÉ Informations activit√©    -->
<!-- ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù -->
<div class="card" style="position:relative; padding:18px; margin-bottom:16px;">

  {% if level %}
  <div style="position:absolute; top:-12px; right:12px;">
    <div style="position:relative; width:70px; height:55px;">
      <div style="
        position:absolute; inset:0;
        clip-path:polygon(50% 0, 92% 40%, 70% 100%, 30% 100%, 8% 40%);
        background:#fff; box-shadow:0 4px 10px rgba(0,0,0,0.25);
      "></div>

      <div style="
        position:absolute; inset:3px;
        clip-path:polygon(50% 0, 92% 40%, 70% 100%, 30% 100%, 8% 40%);
        background:{{ level_color }}; color:#fff;
        display:flex; flex-direction:column; align-items:center; justify-content:center;
        font-weight:700; padding-top:8px;
      ">
        <div style="font-size:0.55rem;">Niveau</div>
        <div style="font-size:1rem; margin-top:2px;">{{ level }}</div>
      </div>
    </div>
  </div>
  {% endif %}

  <h2 style="margin:0 0 8px 0; font-size:1.1rem; font-weight:600;">
    {{ activity.name or "Activit√© sans nom" }}
  </h2>

  <div class="activity-stats-grid">
    <div><div class="tile-k">Distance</div><div class="tile-v">{{ dist_km }} km</div></div>
    <div><div class="tile-k">D+</div><div class="tile-v">{{ dplus }} m</div></div>
    <div><div class="tile-k">Dur√©e</div>
      <div class="tile-v">
        {% set h = duration_sec // 3600 %}
        {% set m = (duration_sec % 3600) // 60 %}
        {{ h }}h{{ m }}
      </div>
    </div>
    <div><div class="tile-k">FC moy</div><div class="tile-v">{{ fc }}</div></div>

    {% if gly_avg %}
      <div><div class="tile-k">Gly moy</div><div class="tile-v">{{ gly_avg|round(0) }} mg/dL</div></div>
    {% endif %}
  </div>
</div>

<!-- ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó -->
<!--      ‚¨ÖÔ∏è Menu lat√©ral / contenu  -->
<!-- ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù -->
<div class="activity-layout">

  <!-- üß≠ Colonne gauche : petit menu "√† la Strava" -->
  <aside class="card activity-sidebar">
    {% set base_url = request.url.path %}

    <a href="{{ base_url }}?tab=overview"
       style="
         display:block; padding:8px 10px; border-radius:4px;
         text-decoration:none;
         margin-bottom:4px;
         {% if tab == 'overview' %}
           background:#0f172a; color:#f9fafb; font-weight:600;
         {% else %}
           color:#111827;
         {% endif %}
       ">
      Vue d‚Äôensemble
    </a>

    <a href="{{ base_url }}?tab=segments"
       style="
         display:block; padding:8px 10px; border-radius:4px;
         text-decoration:none;
         margin-bottom:4px;
         {% if tab == 'segments' %}
           background:#0f172a; color:#f9fafb; font-weight:600;
         {% else %}
           color:#111827;
         {% endif %}
       ">
      {% if is_running_activity %}
        Marche ou course ?
      {% else %}
        Cadence
      {% endif %}
    </a>

    <a href="{{ base_url }}?tab=climbs"
       style="
         display:block; padding:8px 10px; border-radius:4px;
         text-decoration:none;
         margin-bottom:4px;
         {% if tab == 'climbs' %}
           background:#0f172a; color:#f9fafb; font-weight:600;
         {% else %}
           color:#111827;
         {% endif %}
       ">
      Mont√©es remarquables
    </a>

    <a href="{{ base_url }}?tab=glycemia"
       style="
         display:block; padding:8px 10px; border-radius:4px;
         text-decoration:none;
         margin-bottom:4px;
         {% if tab == 'glycemia' %}
           background:#0f172a; color:#f9fafb; font-weight:600;
         {% else %}
           color:#111827;
         {% endif %}
       ">
      Suivi de la glyc√©mie
    </a>

    <a href="{{ base_url }}?tab=vam"
       style="
         display:block; padding:8px 10px; border-radius:4px;
         text-decoration:none;
         margin-bottom:4px;
         {% if tab == 'vam' %}
           background:#0f172a; color:#f9fafb; font-weight:600;
         {% else %}
           color:#111827;
         {% endif %}
       ">
      Vitesse ascensionnelle (m/hr)
    </a>

    <a href="{{ base_url }}?tab=splits"
       style="
         display:block; padding:8px 10px; border-radius:4px;
         text-decoration:none;
         margin-bottom:4px;
         {% if tab == 'splits' %}
           background:#0f172a; color:#f9fafb; font-weight:600;
         {% else %}
           color:#111827;
         {% endif %}
       ">
      D√©tail de la course
    </a>

  </aside>

  <!-- üß© Colonne droite : contenu selon l‚Äôonglet -->
  <main>

    {# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ONGLET 1 : VUE D‚ÄôENSEMBLE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê #}
    <div class="activity-tab {% if tab == 'overview' %}is-active{% endif %}" data-tab="overview">
      <div class="card" style="padding:0; overflow:hidden;">
        <div class="overview-layout" style="
          display:grid;
          grid-template-columns: minmax(0,0.9fr) 1px minmax(0,1.1fr);
          min-height:260px;
        ">
          <div class="overview-map-container" style="padding:16px;">
            {% if has_gps %}
              <div id="map" class="overview-map" style="width:100%;height:260px;border-radius:2px;"></div>
              <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
              <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
              <script>
                const gpsPts = {{ gps_js|safe }};
                if (gpsPts.length > 1) {
                  const map = L.map('map');
                  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                  const poly = L.polyline(gpsPts,{color:'#fc4c02',weight:4}).addTo(map);
                  map.fitBounds(poly.getBounds());
                }
              </script>
            {% else %}
              <p class="muted">Pas de GPS.</p>
            {% endif %}
          </div>
          <div class="overview-divider" style="background:#e5e7eb;"></div>
          <div class="overview-vam" style="padding:16px;">
            <h3 style="margin-top:0; margin-bottom:10px; font-size:0.9rem;">
              VAM (m/h) par % de pente et zone cardio
            </h3>
            <div class="table-responsive">
              <table class="vam-table" style="width:100%; border-collapse:collapse; font-size:0.75rem; min-width:420px;">
                <thead>
                  <tr style="border-bottom:1px solid #e5e7eb;">
                    <th style="text-align:left;">Pente</th>
                    {% for z in hr_zones %}
                    <th style="text-align:right;">{{ z }}</th>
                    {% endfor %}
                  </tr>
                </thead>
                <tbody>
                {% for slope_id, slope_label in slopes_order %}
                  {% if not slope_id.startswith('Sneg') %}
                  <tr style="border-bottom:1px solid #f3f4f6;">
                    <td style="padding:4px 0;">{{ slope_label }}</td>
                    {% for z in hr_zones %}
                    {% set v = vam_by_slope_zone[slope_id][z] %}
                    <td style="text-align:right; padding:4px 0;">
                      {% if v is not none %}
                        {{ v|round(0) }}
                      {% else %}
                        ‚Äì
                      {% endif %}
                    </td>
                    {% endfor %}
                  </tr>
                  {% endif %}
                {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>


    {# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ONGLET 2 : SEGMENTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê #}
    <div class="activity-tab {% if tab == 'segments' %}is-active{% endif %}" data-tab="segments">

      {# S√©lecteur du nombre de tron√ßons sp√©cifique √† l‚Äôonglet SEGMENTS #}
      <form method="get"
            action="{{ request.url.path }}"
            style="
              margin:0 0 16px 0;
              display:flex;
              align-items:center;
              gap:10px;
              font-size:0.9rem;
            ">

        {# On force tab=segments pour rester sur cet onglet apr√®s submit #}
        <input type="hidden" name="tab" value="segments">

        <label for="segments-seg" style="white-space:nowrap;">
          D√©couper le parcours en :
        </label>

        <select id="segments-seg"
                name="segments"
                onchange="this.form.submit()"
                style="
                  padding:4px 6px;
                  font-size:0.85rem;
                  width:110px;
                  border:1px solid #d1d5db;
                  border-radius:4px;
                  background:white;
                ">
          {% for n in range(2, 8) %}
            <option value="{{ n }}"
                    {% if n == current_seg_count %}selected{% endif %}>
              {{ n }} tron√ßons
            </option>
          {% endfor %}
        </select>
      </form>

      <!-- Vue globale par tron√ßon -->
      <div class="card"
          style="
              margin-top:0;
              border:3px solid #0f766e;
              border-radius:4px;
              padding:16px;
          ">

        <h3 style="margin-top:0; color:#0f766e; font-weight:700;">
          Vue globale par tron√ßon
        </h3>

        <div class="table-responsive">
        <table style="width:100%;border-collapse:collapse;font-size:0.85rem; min-width:620px;">
          <thead>
            <tr style="border-bottom:1px solid #e5e7eb;">
              <th style="text-align:left;">Tron√ßon</th>
              {% for seg in segments_km_labels %}
                <th style="text-align:center;">{{ seg }}</th>
              {% endfor %}
            </tr>
          </thead>

          <tbody>

            <!-- FC moyenne -->
            <tr style="border-bottom:1px solid #f3f4f6;">
              <td>FC moy</td>
              {% for seg in segments_km_labels %}
                {% set idx = loop.index0 %}
                {% set hr = hr_by_segment[idx] %}
                <td style="text-align:center; padding:4px 2px;">
                  {% if hr is not none %}
                    <span style="color:#000; font-weight:400;">{{ hr }} bpm</span>
                  {% else %}
                    <span style="opacity:0.3;">‚Äì</span>
                  {% endif %}
                </td>
              {% endfor %}
            </tr>

            <!-- Allure moyenne -->
            <tr style="border-bottom:1px solid #f3f4f6;">
              <td>Allure moy</td>
              {% for seg in segments_km_labels %}
                {% set idx = loop.index0 %}
                {% set pace = pace_by_segment[idx] %}
                <td style="text-align:center; padding:4px 2px;">
                  {% if pace %}
                    <span style="color:#000; font-weight:400;">{{ pace }}</span>
                  {% else %}
                    <span style="opacity:0.3;">‚Äì</span>
                  {% endif %}
                </td>
              {% endfor %}
            </tr>

            <!-- D+ -->
            <tr style="border-bottom:1px solid #f3f4f6;">
              <td>D+</td>
              {% for seg in segments_km_labels %}
                {% set idx = loop.index0 %}
                {% set dplus = dplus_by_segment[idx] %}
                <td style="text-align:center; padding:4px 2px;">
                  {% if dplus is not none %}
                    <span style="color:#000; font-weight:400;">{{ dplus }} m</span>
                  {% else %}
                    <span style="opacity:0.3;">‚Äì</span>
                  {% endif %}
                </td>
              {% endfor %}
            </tr>

            <!-- D- -->
            <tr>
              <td>D-</td>
              {% for seg in segments_km_labels %}
                {% set idx = loop.index0 %}
                {% set dminus = dminus_by_segment[idx] %}
                <td style="text-align:center; padding:4px 2px;">
                  {% if dminus is not none %}
                    <span style="color:#000; font-weight:400;">{{ dminus }} m</span>
                  {% else %}
                    <span style="opacity:0.3;">‚Äì</span>
                  {% endif %}
                </td>
              {% endfor %}
            </tr>

          </tbody>
        </table>
        </div>
      </div>

      <!-- Cadence & Mouvement -->
      <div style="padding:16px; border-top:1px solid #e5e7eb; margin-top:16px; background:white; border-radius:4px;">

        <h3 style="margin:0 0 10px 0;">
          {% if is_running_activity %}
            Cadence de pas par % de pente par tron√ßons
          {% else %}
            Cadence par % de pente par tron√ßons
          {% endif %}
        </h3>

        <div class="table-responsive">
        <table style="width:100%;border-collapse:collapse;font-size:0.85rem; min-width:620px;">
          <thead>
            <tr style="border-bottom:1px solid #e5e7eb;">
              <th style="text-align:left;">Pente</th>
              {% for seg in segments_km_labels %}
                <th style="text-align:center;">{{ seg }}</th>
              {% endfor %}
            </tr>
          </thead>

          <tbody>
            {% for slope_id, slope_label in slopes_order %}
            <tr style="border-bottom:1px solid #f3f4f6;">
              <td>{{ slope_label }}</td>

              {% for seg in segments_km_labels %}
                {% set idx = loop.index0 %}
                {% set cell = progression_table[slope_id][idx] %}

                {% set bg = "" %}
                {% if is_running_activity %}
                  {% if cell.class == "MARCHE" %}
                      {% set bg = "background:#fecaca;" %}
                  {% elif cell.class == "TROTTINAGE" %}
                      {% set bg = "background:#fef9c3;" %}
                  {% elif cell.class == "COURSE" %}
                      {% set bg = "background:#bbf7d0;" %}
                  {% endif %}
                {% endif %}

                <td style="text-align:center; padding:4px 2px; {{ bg }}">

                  {% if cell.ppm is not none %}
                    <div style="font-size:{% if is_running_activity %}0.65rem{% else %}0.85rem{% endif %}; color:#4b5563; font-weight:{% if not is_running_activity %}600{% else %}400{% endif %};">
                      {{ cell.ppm }} {% if is_running_activity %}ppm{% else %}rpm{% endif %}
                    </div>
                    {% if is_running_activity and cell.class not in (None, "n/a") %}
                      <div style="font-size:0.80rem; font-weight:700;">
                        {{ cell.class }}
                      </div>
                    {% endif %}
                  {% else %}
                    <span style="opacity:0.3;">‚Äì</span>
                  {% endif %}

                </td>

              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
        </div>

      </div>

    </div> {# fin onglet segments #}



    {# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ONGLET 3 : MONT√âES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê #}
    <div class="activity-tab {% if tab == 'climbs' %}is-active{% endif %}" data-tab="climbs">

      <!-- Mont√©es remarquables -->
      <div id="climbs-section"
           style="padding:16px; border-top:1px solid #e5e7eb; margin-top:0; background:white; border-radius:4px;">
          <h3 style="margin:0 0 10px 0;">
            Mont√©es remarquables de la sortie
            <span style="font-weight:400; font-size:0.8em; opacity:0.9;">
              (Clique sur une ligne pour voir la mont√©e)
            </span>
          </h3>
        {% if climbs and climbs|length > 0 %}
          <table style="
            width:100%;
            border-collapse:collapse;
            font-size:0.75rem;          /* police plus petite */
            line-height:1.15;           /* plus compact */
          ">
            <thead>
              <tr style="border-bottom:1px solid #e5e7eb;">
                <th style="padding:4px 2px; text-align:center; font-weight:600;">D√©but</th>
                <th style="padding:4px 2px; text-align:center; font-weight:600;">Fin</th>
                <th style="padding:4px 2px; text-align:center; font-weight:600;">Km</th>
                <th style="padding:4px 2px; text-align:center; font-weight:600;">D+ net</th>
                <th style="padding:4px 2px; text-align:center; font-weight:600;">D+</th>
                <th style="padding:4px 2px; text-align:center; font-weight:600;">D-</th>
                <th style="padding:4px 2px; text-align:center; font-weight:600;">Pente</th>
                <th style="padding:4px 2px; text-align:center; font-weight:600;">FC</th>
                <th style="padding:4px 2px; text-align:center; font-weight:600;">VAM</th>
                <th style="padding:4px 2px; text-align:center; font-weight:600;">Allure</th>
              </tr>
            </thead>

            <tbody>
              {% for c in climbs %}
                <tr
                  onclick="window.location='{{ request.url.path }}?tab=climbs&segments={{ current_seg_count }}&climb_start={{ c.start_idx }}&climb_end={{ c.end_idx }}#climbs-section';"
                  style="
                    cursor:pointer;
                    border-bottom:1px solid #f3f4f6;
                    transition:background 0.15s ease;
                  "
                  onmouseover="this.style.background='#f9fafb';"
                  onmouseout="this.style.background='white';"
                >
                  <td style="text-align:center; padding:4px 2px;">{{ c.km_debut|round(1) }}</td>
                  <td style="text-align:center; padding:4px 2px;">{{ c.km_fin|round(1) }}</td>
                  <td style="text-align:center; padding:4px 2px;">{{ (c.longueur_m / 1000.0)|round(1) }}</td>

                  <td style="text-align:center; padding:4px 2px;">{{ c.denivele_m|round(0)|int }}</td>
                  <td style="text-align:center; padding:4px 2px;">{{ c.dplus_brut|round(0)|int }}</td>
                  <td style="text-align:center; padding:4px 2px;">{{ c.dminus_brut|round(0)|int }}</td>

                  <td style="text-align:center; padding:4px 2px;">{{ c.pente_moy_pct|round(0)|int }}%</td>

                  <td style="text-align:center; padding:4px 2px;">
                    {% if c.hr_avg %}
                      {{ c.hr_avg|round(0)|int }}
                    {% else %}
                      ‚Äì
                    {% endif %}
                  </td>

                  <td style="text-align:center; padding:4px 2px;">
                    {% if c.avg_vam %}
                      {{ c.avg_vam|round(0)|int }}
                    {% else %}
                      ‚Äì
                    {% endif %}
                  </td>

                  <td style="text-align:center; padding:4px 2px;">
                    {% if c.avg_pace %}
                      {{ c.avg_pace }}
                    {% else %}
                      ‚Äì
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>


        {% else %}
          <p style="font-size:0.85rem; opacity:0.7;">Aucune mont√©e remarquable d√©tect√©e avec les param√®tres actuels.</p>
        {% endif %}
      </div>

      {% if selected_climb %}

        <!-- Bloc d√©tails + profil altitude en dessous -->
        <div style="margin:16px 0 0 0; padding:12px; border:1px solid #e5e7eb; border-radius:4px; background:white;">

          <h4 style="margin:0 0 8px 0;">D√©tails de la mont√©e s√©lectionn√©e</h4>

          <p style="margin:0 0 6px 0; font-size:0.85rem;">
            Du km {{ selected_climb.km_debut|round(1) }}
            au km {{ selected_climb.km_fin|round(1) }} ‚Äî
            longueur {{ (selected_climb.longueur_m / 1000.0)|round(1) }} km,
            D+ net {{ selected_climb.denivele_m|round(0)|int }} m
            (D+ {{ selected_climb.dplus_brut|round(0)|int }} m,
             D- {{ selected_climb.dminus_brut|round(0)|int }} m),
            pente moy. {{ selected_climb.pente_moy_pct|round(0)|int }}%.
          </p>

          <p style="margin:0 0 8px 0; font-size:0.85rem;">
            VAM moy :
            {% if selected_climb.avg_vam %}
              {{ selected_climb.avg_vam|round(0)|int }} m/h
            {% else %}
              ‚Äì
            {% endif %}
            &nbsp;|&nbsp;
            Allure moy :
            {% if selected_climb.avg_pace %}
              {{ selected_climb.avg_pace }}
            {% else %}
              ‚Äì
            {% endif %}
            &nbsp;|&nbsp;
            FC moy :
            {% if selected_climb.hr_avg %}
              {{ selected_climb.hr_avg|round(0)|int }} bpm
            {% else %}
              ‚Äì
            {% endif %}
          </p>

          <div style="margin-top:8px; height:220px;">
            <canvas id="altitudeChart" width="800" height="220"></canvas>
          </div>
        </div>

        <!-- Script du profil altitude "style Strava" -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
          (function() {
            const rawAltData = {{ alt_profile_js | safe }};
            if (!rawAltData || rawAltData.length === 0) return;

            const kmDebut = {{ selected_climb.km_debut }};
            const kmFin   = {{ selected_climb.km_fin }};

            // Profil complet {x: km, y: alt}
            const altData = rawAltData.map(pt => ({ x: pt[0], y: pt[1] }));

            // Mont√©e s√©lectionn√©e (pour les points de d√©but / fin)
            const climbPoints = altData.filter(pt => pt.x >= kmDebut && pt.x <= kmFin);
            const startPoint  = climbPoints.length > 0 ? [climbPoints[0]] : [];
            const endPoint    = climbPoints.length > 1 ? [climbPoints[climbPoints.length - 1]] : [];

            // Dataset sp√©cial : m√™me profil, mais avec des valeurs null en dehors de la mont√©e
            const highlightedClimbData = altData.map(pt =>
              (pt.x >= kmDebut && pt.x <= kmFin)
                ? { x: pt.x, y: pt.y }
                : { x: pt.x, y: null }
            );

            const ctx = document.getElementById('altitudeChart').getContext('2d');

            new Chart(ctx, {
              type: 'line',
              data: {
                datasets: [
                  {
                    label: 'Profil altitude',
                    data: altData,
                    borderColor: '#000099',
                    borderWidth: 1,
                    pointRadius: 0,
                    tension: 0.25,
                    fill: true,
                    backgroundColor: 'rgba(148, 163, 184, 0.15)',
                    order: 1
                  },
                  {
                    label: 'Mont√©e s√©lectionn√©e',
                    data: highlightedClimbData,
                    borderColor: '#000099',
                    borderWidth: 1,
                    pointRadius: 2,
                    tension: 0.25,
                    fill: false,
                    order: 2
                  },
                  {
                    type: 'scatter',
                    label: 'D√©but mont√©e',
                    data: startPoint,
                    backgroundColor: '#000099',
                    borderColor: '#000099',
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    showLine: false,
                    order: 3
                  },
                  {
                    type: 'scatter',
                    label: 'Fin mont√©e',
                    data: endPoint,
                    backgroundColor: '#000099',
                    borderColor: '#000099',
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    showLine: false,
                    order: 3
                  }
                ]
              },
              options: {
                responsive: false,
                maintainAspectRatio: false,
                animation: false,
                plugins: {
                  legend: {
                    display: false
                  },
                  tooltip: {
                    intersect: false,
                    mode: 'index',
                    callbacks: {
                      label: function(context) {
                        const x = context.parsed.x;
                        const y = context.parsed.y;
                        if (x == null || y == null) return '';
                        const inClimb = (x >= kmDebut && x <= kmFin);
                        const base = `${x.toFixed(1)} km ‚Äì ${Math.round(y)} m`;
                        return inClimb ? `${base} (mont√©e)` : base;
                      }
                    }
                  }
                },
                scales: {
                  x: {
                    type: 'linear',
                    title: { display: true, text: 'Distance (km)' },
                    ticks: { stepSize: 1 },
                    grid: { color: 'rgba(148, 163, 184, 0.2)' }
                  },
                  y: {
                    title: { display: true, text: 'Altitude (m)' },
                    grid: { color: 'rgba(148, 163, 184, 0.2)' }
                  }
                },
                elements: {
                  line: { tension: 0.25 }
                }
              }
            });
          })();
        </script>
      {% endif %}

    </div> {# fin onglet climbs #}

    {# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ONGLET 4 : GLYC√âMIE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê #}
    {% if has_glucose %}
    <div class="activity-tab {% if tab == 'glycemia' %}is-active{% endif %}" data-tab="glycemia">

      <div class="card"
          style="margin-top:0; border-radius:4px; padding:16px;">

        <h3 style="margin:0 0 10px 0; font-size:0.95rem;">
          Distribution de la glyc√©mie pendant la sortie
        </h3>

        <div class="table-responsive">
        <table style="width:100%; border-collapse:collapse; font-size:0.85rem; min-width:560px;">
          <thead>
            <tr style="border-bottom:1px solid #e5e7eb;">
              <th style="text-align:left;">Zone</th>
              <th style="text-align:left;">Description</th>
              <th style="text-align:left;">Plage</th>
              <th style="text-align:right;">Temps</th>
              <th style="text-align:right;">% temps</th>
              <th style="text-align:left; width:40%;">R√©partition</th>
            </tr>
          </thead>

          <tbody>
            {% for row in glucose_zone_rows %}
            {% set bar_color =
                  '#ef4444' if row.zone_index == 1 else
                  '#facc15' if row.zone_index == 5 else
                  '#15803d'  %}

            <tr style="border-bottom:1px solid #f3f4f6;">
              <td>{{ row.name }}</td>
              <td>{{ row.description }}</td>
              <td>{{ row.range }}</td>
              <td style="text-align:right;">{{ row.time_str }}</td>
              <td style="text-align:right;">{{ row.percent }}%</td>

              <td>
                <div style="
                  background:#e5e7eb;
                  border-radius:999px;
                  overflow:hidden;
                  height:14px;
                ">
                  <div style="
                    width:{{ row.percent }}%;
                    height:100%;
                    background:{{ bar_color }};
                  "></div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        </div>

        <p style="margin-top:10px; font-size:0.7rem; color:#6b7280;">
          Zones actuelles : &lt;70, 70‚Äì100, 100‚Äì140, 140‚Äì180, &gt;180 mg/dL.
          (personnalisables).
        </p>

      </div>

      {% if glucose_zone_vs_hr_rows %}
      <div class="card" style="margin-top:16px; border-radius:4px; padding:16px;">
        <h3 style="margin:0 0 10px 0; font-size:0.95rem;">
          Couplage cardio √ó glyc√©mie
        </h3>

        <div style="
          display:grid;
          grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
          gap:12px;
          margin:8px 0 16px 0;
        ">
          {% if glucose_profile_summary %}
          <div style="
            border-radius:6px;
            padding:12px;
            background:{{ glucose_profile_summary.bg_color }};
            color:{{ glucose_profile_summary.fg_color }};
          ">
            <div style="font-size:0.7rem; text-transform:uppercase; letter-spacing:.05em;">
              Profil glyc√©mie
            </div>
            <div style="font-weight:600; font-size:1rem; margin-top:4px;">
              {{ glucose_profile_summary.label }}
            </div>
            <div style="font-size:0.85rem; margin-top:6px;">
              {{ glucose_profile_summary.detail }}
            </div>
          </div>
          {% endif %}

          {% if activity_type_summary %}
          <div style="
            border-radius:6px;
            padding:12px;
            background:{{ activity_type_summary.bg_color }};
            color:{{ activity_type_summary.fg_color }};
          ">
            <div style="font-size:0.7rem; text-transform:uppercase; letter-spacing:.05em;">
              Type d‚Äôeffort
            </div>
            <div style="font-weight:600; font-size:1rem; margin-top:4px;">
              {{ activity_type_summary.label }}
            </div>
            <div style="font-size:0.85rem; margin-top:6px;">
              {{ activity_type_summary.detail }}
            </div>
          </div>
          {% endif %}
        </div>

        <div class="table-responsive" style="width:100%; overflow-x:auto;">
          <table style="width:100%; border-collapse:collapse; font-size:0.8rem;">
            <thead>
              <tr>
                <th style="border:none;"></th>
                <th style="border:none;"></th>
                <th colspan="{{ glucose_hr_columns|length }}"
                    style="
                      text-align:center;
                      font-size:0.85rem;
                      font-weight:600;
                      color:#0f172a;
                      padding-bottom:6px;
                    ">
                  Colonnes = zones cardio
                </th>
              </tr>
              <tr style="border-bottom:1px solid #e5e7eb;">
                <th style="text-align:left;">Zone glyc√©mie</th>
                <th style="text-align:left;">Plage</th>
                {% for col in glucose_hr_columns %}
                <th style="text-align:center; font-weight:400;">
                  {{ col.zone }}
                  <div class="muted" style="font-size:0.7rem;">
                    {{ col.time_str }} ¬∑ {{ col.percent_of_total }}%
                  </div>
                </th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for row in glucose_zone_vs_hr_rows %}
              <tr style="border-bottom:1px solid #f3f4f6;">
                <td>{{ row.name }}</td>
                <td>{{ row.range }}</td>
                {% for cell in row.hr_cells %}
                <td style="text-align:center; padding:6px 4px;">
                  <div style="font-weight:600;">{{ cell.time_str }}</div>
                  <div class="muted" style="font-size:0.7rem;">
                    {% if cell.time_sec > 0 %}
                      {{ cell.percent_of_hr }}% de {{ cell.hr_zone }}
                    {% else %}
                      ‚Äì
                    {% endif %}
                  </div>
                </td>
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        {% if hr_zone_summary %}
        <div style="margin-top:14px; font-size:0.75rem; color:#475569;">
          {% for zone in hr_zone_summary %}
          <span style="display:inline-block; margin-right:12px;">
            <strong>{{ zone.zone }}</strong>&nbsp;{{ zone.time_str }}
            ({{ zone.percent }}%)
          </span>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      {% endif %}

      {% if glucose_chart_points and glucose_chart_points|length > 1 %}
      <div class="card" style="margin-top:16px; border-radius:4px; padding:16px;">
        <h3 style="margin:0 0 10px 0; font-size:0.95rem;">
          Courbe de glyc√©mie pendant l‚Äôactivit√©
        </h3>
        <p class="muted" style="margin:0 0 12px 0; font-size:0.8rem;">
          Graphe temporel bas√© sur les points CGM synchronis√©s avec ta sortie.
        </p>
        <div style="height:260px;">
          <canvas id="glucoseActivityChart" height="240"></canvas>
        </div>
      </div>

      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
      <script>
        (function() {
          const rawPoints = {{ glucose_chart_points | tojson | safe }};
          if (!rawPoints || rawPoints.length === 0) return;

          const useTimeAxis = rawPoints.every(pt => !!pt.ts);
          const series = rawPoints.map(pt => ({
            x: useTimeAxis ? new Date(pt.ts) : pt.elapsed_sec / 60,
            y: pt.mgdl
          }));

          const labels = useTimeAxis ? undefined : series.map(pt => pt.x.toFixed(1));

          const ctx = document.getElementById('glucoseActivityChart').getContext('2d');
          new Chart(ctx, {
            type: 'line',
            data: {
              labels,
              datasets: [{
                label: 'Glyc√©mie (mg/dL)',
                data: useTimeAxis ? series : series.map(pt => pt.y),
                borderColor: '#dc2626',
                backgroundColor: 'rgba(220,38,38,0.12)',
                borderWidth: 2,
                pointRadius: 0,
                tension: 0.15,
                fill: true,
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: { mode: 'index', intersect: false },
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    title: items => {
                      const idx = items[0].dataIndex;
                      const raw = rawPoints[idx];
                      if (raw.ts) {
                        return new Date(raw.ts).toLocaleString('fr-FR');
                      }
                      const minutes = (raw.elapsed_sec / 60).toFixed(1);
                      return `${minutes} min depuis le d√©part`;
                    },
                    label: item => `${item.formattedValue} mg/dL`,
                  }
                }
              },
              scales: {
                x: useTimeAxis
                  ? {
                      type: 'time',
                      time: { unit: 'hour', displayFormats: { hour: 'HH:mm' } },
                      ticks: { maxTicksLimit: 8 },
                      grid: { display: false },
                    }
                  : {
                      title: { display: true, text: 'Temps (min)' },
                      ticks: { maxTicksLimit: 8 },
                      grid: { display: false },
                    },
                y: {
                  suggestedMin: 60,
                  suggestedMax: 220,
                  grid: { color: '#e5e7eb' },
                  title: { display: true, text: 'mg/dL' },
                }
              }
            }
          });
        })();
      </script>
      {% endif %}

    </div>
    {% endif %}


    {# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ONGLET 5 : VITESSE ASCENSIONNELLE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê #}
    {% if has_vam %}
    <div class="activity-tab {% if tab == 'vam' %}is-active{% endif %}" data-tab="vam">

      <div class="card"
          style="margin-top:0; border-radius:4px; padding:16px;">

        <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:12px;">
          <h3 style="margin:0; font-size:0.95rem;">
            Temps pass√© par zone de vitesse ascensionnelle
          </h3>

          <!-- Menu d√©roulant de filtre par zone cardio -->
          <form method="get"
                style="margin:0; font-size:0.85rem; display:flex; align-items:center; gap:6px;">
            <input type="hidden" name="tab" value="vam">
            <input type="hidden" name="segments" value="{{ current_seg_count }}">

            <label for="vam_hr" style="white-space:nowrap;">Zone cardio :</label>
            <select id="vam_hr"
                    name="vam_hr"
                    onchange="this.form.submit()"
                    style="font-size:0.85rem; padding:2px 4px; border-radius:3px; border:1px solid #d1d5db;">
              <option value="ALL" {% if vam_hr_filter == 'ALL' %}selected{% endif %}>
                Toutes zones
              </option>
              {% for z in hr_zones %}
                <option value="{{ z }}" {% if vam_hr_filter == z %}selected{% endif %}>
                  {{ z }}
                </option>
              {% endfor %}
            </select>
          </form>
        </div>

        <table style="width:100%; border-collapse:collapse; font-size:0.85rem; margin-top:10px;">
          <thead>
            <tr style="border-bottom:1px solid #e5e7eb;">
              <th style="text-align:left;">Zone VAM</th>
              <th style="text-align:left;">Plage (m/h)</th>
              <th style="text-align:right;">Temps</th>
              <th style="text-align:right;">% temps</th>
              <th style="text-align:left; width:45%;">R√©partition</th>
            </tr>
          </thead>

          <tbody>
            {% for row in vam_zone_rows %}
            <tr style="border-bottom:1px solid #f3f4f6;">
              <td>{{ row.name }}</td>
              <td>{{ row.range }}</td>
              <td style="text-align:right;">{{ row.time_str }}</td>
              <td style="text-align:right;">{{ row.percent }}%</td>
              <td>
                <div style="
                  background:#e5e7eb;
                  border-radius:999px;
                  overflow:hidden;
                  height:14px;
                ">
                  <div style="
                    width:{{ row.percent }}%;
                    height:100%;
                    background:#000099;  /* bleu */
                  "></div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

        <p style="margin-top:10px; font-size:0.7rem; color:#6b7280;">
          Zones VAM utilis√©es : &lt;300, 300‚Äì600, 600‚Äì900, 900‚Äì1200, &gt;1200 m/h
          (ajustables dans le code).
          <br>
          {% if vam_hr_filter == 'ALL' %}
            Filtre actuel : <strong>toutes zones cardiaques</strong>.
          {% else %}
            Filtre actuel : <strong>{{ vam_hr_filter }}</strong>.
          {% endif %}
        </p>
      </div>

    </div>
    {% endif %}

{# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ONGLET 6 : SPLITS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê #}
<div class="activity-tab {% if tab == 'splits' %}is-active{% endif %}" data-tab="splits">

  <div class="card"
      style="margin-top:0; border-radius:4px; padding:16px;">

    <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:12px;">
      <h3 style="margin:0; font-size:0.95rem;">
        Splits par {{ split_km|int }} km
      </h3>

      <!-- S√©lecteur de taille de splits -->
      <form method="get"
            style="margin:0; font-size:0.85rem; display:flex; align-items:center; gap:6px;">
        <input type="hidden" name="tab" value="splits">

        <label for="split_km" style="white-space:nowrap;">Taille des splits :</label>
        <select id="split_km"
                name="split_km"
                onchange="this.form.submit()"
                style="font-size:0.85rem; padding:2px 4px; border-radius:3px; border:1px solid #d1d5db;">
          {% for opt in split_km_options %}
            <option value="{{ opt }}"
                    {% if opt == split_km %}selected{% endif %}>
              {{ opt }} km
            </option>
          {% endfor %}
        </select>
      </form>
    </div>

    <table style="width:100%; border-collapse:collapse; font-size:0.85rem; margin-top:10px;">
      <thead>
        <tr style="border-bottom:1px solid #e5e7eb;">
          <th style="text-align:left;">Split</th>
          <th style="text-align:right;">Dist.</th>
          <th style="text-align:right;">Temps</th>
          <th style="text-align:right;">Allure</th>
          <th style="text-align:right;">FC moy</th>
          <th style="text-align:right;">Cad moy</th>
          <th style="text-align:right;">Gly moy</th>
          <th style="text-align:right;">D+</th>
          <th style="text-align:right;">D-</th>
          <th style="text-align:right;">D+ cum.</th>
          <th style="text-align:right;">D- cum.</th>
          <th style="text-align:right;">VAM max 1'</th>
          <th style="text-align:right;">VAM split</th>
        </tr>
      </thead>

      <tbody>
        {% if splits_rows %}
          {% for row in splits_rows %}
          <tr
            style="
              {% if loop.index is even %}
                background:#f9fafb;
              {% else %}
                background:white;
              {% endif %}
              border-bottom:1px solid #e5e7eb;
            "
          >

            <!-- Split size -->
            <td style="text-align:center;">
              {{ row.split_km|round(1) }} km
            </td>

            <!-- Dist cumul√©e -->
            <td style="text-align:center;">
              {{ row.split_cum_km|round(1) }} km
            </td>

            <!-- Temps -->
            <td style="text-align:center;">{{ row.time_str }}</td>

            <!-- Allure -->
            <td style="text-align:center;">
              {% if row.pace %}{{ row.pace }}{% else %}‚Äì{% endif %}
            </td>

            <!-- FC moy -->
            <td style="text-align:center;">
              {% if row.hr_avg is not none %}{{ row.hr_avg }}{% else %}‚Äì{% endif %}
            </td>

            <!-- Cad moy -->
            <td style="text-align:center;">
              {% if row.cad_avg is not none %}{{ row.cad_avg }}{% else %}‚Äì{% endif %}
            </td>

            <!-- Gly moy -->
            <td style="text-align:center;">
              {% if row.gly_avg is not none %}{{ row.gly_avg }}{% else %}‚Äì{% endif %}
            </td>

            <!-- D+ / D- -->
            <td style="text-align:center;">{{ row.dplus }}</td>
            <td style="text-align:center;">{{ row.dminus }}</td>

            <!-- D+ cum / D- cum -->
            <td style="text-align:center;">{{ row.dplus_cum }}</td>
            <td style="text-align:center;">{{ row.dminus_cum }}</td>

            <!-- VAM max 1' -->
            <td style="text-align:center;">
              {% if row.vam_max_1min is not none %}
                {{ row.vam_max_1min }}
              {% else %}
                ‚Äì
              {% endif %}
            </td>

            <!-- VAM split -->
            <td style="text-align:center;">
              {% if row.vam_seg is not none %}
                {{ row.vam_seg }}
              {% else %}
                ‚Äì
              {% endif %}
            </td>

          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="13" style="text-align:center; padding:8px; color:#9ca3af;">
              Aucun split disponible pour cette activit√©.
            </td>
          </tr>
        {% endif %}
      </tbody>

    </table>

  </div>

</div>






  </main>
</div>

{% endblock %}
