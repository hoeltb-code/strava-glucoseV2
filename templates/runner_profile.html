{% extends "base.html" %}
{% block title %}Profil coureur ¬∑ {{ user.first_name or user.email }}{% endblock %}

{% block extra_head %}
<style>
  .runner-layout {
    display:grid;
    grid-template-columns:210px minmax(0,1fr);
    gap:16px;
    align-items:flex-start;
  }
  .runner-sidebar a {
    display:block;
    padding:8px 10px;
    border-radius:4px;
    text-decoration:none;
    margin-bottom:4px;
  }
  .runner-section {
    display:none;
  }
  .runner-section.is-active {
    display:block;
  }

  .runner-section table {
    width:100%;
    border-collapse:collapse;
    table-layout:auto;
  }
  .runner-section table th,
  .runner-section table td {
    padding:4px 3px !important;
    font-size:0.78rem !important;
    white-space:normal !important;
  }
  .runner-section table th span {
    display:block;
    font-size:0.7rem !important;
    line-height:1.2;
  }
  .runner-section p,
  .runner-section .muted {
    font-size:0.78rem !important;
    color:#0f172a !important;
  }

  @media (max-width: 640px) {
    body, p, div, table, th, td, a {
      font-size:0.8rem !important;
    }
    .runner-section p,
    .runner-section .muted {
      font-size:0.7rem !important;
    }
    .runner-section table {
      table-layout:fixed;
    }
    .runner-section table th,
    .runner-section table td {
      font-size:0.7rem !important;
      padding:3px 2px !important;
    }
    .runner-section table th span {
      font-size:0.65rem !important;
    }
  }

  @media (max-width: 900px) {
    .runner-layout {
      grid-template-columns:1fr;
    }
    .runner-sidebar {
      display:none;
    }
    .runner-section {
      display:block !important;
      margin-bottom:16px;
    }
    body, p, div, table, th, td, a {
      font-size:0.85rem !important;
    }
  }

  @media (min-width: 901px) {
    .runner-section {
      display:none;
    }
    .runner-section.is-active {
      display:block;
    }
  }

  .dplus-table th,
  .dplus-table td {
    padding:6px 4px;
    border-bottom:1px solid #e5e7eb;
    white-space:nowrap;
  }

  @media (max-width: 720px) {
    .dplus-table {
      font-size:0.7rem;
    }
    .dplus-table th,
    .dplus-table td {
      padding:4px 2px;
    }
  }
</style>
{% set needs_chart_js = show_glucose_tabs and (
  (glucose_chart_24h and glucose_chart_24h|length > 1)
  or (glucose_activity_chart.labels and glucose_activity_chart.labels|length > 0)
  or (glucose_activity_profile_radar and glucose_activity_profile_radar.has_data)
) %}
{% if needs_chart_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
{% endif %}
{% endblock %}

{% block content %}

<!-- ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó -->
<!--   üßç Header utilisateur + actions  -->
<!-- ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù -->
<div style="
  display:flex; align-items:center; justify-content:space-between;
  padding:16px 0 12px; border-bottom:1px solid var(--border-soft);
  margin-bottom:16px;
">
  <div style="display:flex; align-items:center; gap:14px;">
    <div>
      <div style="font-size:1.1rem; font-weight:600; color:#0f172a;">
        {% if user.first_name or user.last_name %}
          {{ user.first_name or "" }} {{ user.last_name or "" }}
        {% else %}
          {{ user.email }}
        {% endif %}
      </div>
      <div style="margin-top:2px; color:#0f172a;">Profil coureur ¬∑ id={{ user.id }}</div>
    </div>
  </div>

  <div style="display:flex; gap:10px;"><!-- actions d√©plac√©es dans le header global --></div>
</div>

<!-- ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó -->
<!--      üéØ En-t√™te profil coureur -->
<!-- ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù -->
<div class="card" style="padding:14px; margin-bottom:14px;">
  <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
    <div>
      <h2 style="margin:0 0 4px 0; font-size:1.05rem; font-weight:600;">
        {% if sport|lower == 'run' %}
          Voici ton profil (running & trail)
        {% else %}
          Profil coureur ‚Äì {{ sport }}
        {% endif %}
      </h2>
      <p style="margin:0; font-size:0.85rem; color:#0f172a;">
        Ce profil agr√®ge toutes tes sorties pour estimer VAM, rythmes selon la pente et zones cardio,
        projeter tes chronos √† partir d‚Äôun GPX, et, si tu portes un CGM, afficher les analyses glyc√©mie.
        Pense √† renseigner ta FC max dans ton profil pour des zones cardio plus pr√©cises.
      </p>
    </div>

    <form method="get"
          action="{{ request.url.path }}"
          style="display:flex; gap:8px; align-items:center; font-size:0.85rem; flex-wrap:wrap;">

      <input type="hidden" name="sport" value="{{ sport }}">
      <input type="hidden" name="tab" value="{{ tab }}">

      <label for="period" style="white-space:nowrap;">P√©riode :</label>
      <select id="period" name="period"
              onchange="this.form.submit()"
              style="padding:4px 6px; border-radius:4px; border:1px solid #d1d5db; min-width:150px;">
        <option value="all" {% if period == 'all' %}selected{% endif %}>
          Tout l‚Äôhistorique
        </option>
        <option value="last_12_months" {% if period == 'last_12_months' %}selected{% endif %}>
          12 derniers mois
        </option>
        <option value="last_6_months" {% if period == 'last_6_months' %}selected{% endif %}>
          6 derniers mois
        </option>
        <option value="last_3_months" {% if period == 'last_3_months' %}selected{% endif %}>
          3 derniers mois
        </option>
        <option value="last_1_month" {% if period == 'last_1_month' %}selected{% endif %}>
          1 dernier mois
        </option>
      </select>
    </form>
  </div>
</div>

<!-- ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó -->
<!--   ‚¨ÖÔ∏è Menu lat√©ral / contenu     -->
<!-- ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù -->
<div class="runner-layout">

  <!-- üß≠ Colonne gauche : menu onglets -->
  <aside class="card runner-sidebar" style="padding:12px; font-size:0.9rem;">
    <div style="font-weight:600; font-size:0.85rem; margin-bottom:8px;
                text-transform:uppercase; color:#0f172a;">
      Profil coureur
    </div>

    {% set base_url = request.url.path %}

    <!-- Onglet D+ -->
    <a href="{{ base_url }}?sport={{ sport }}&period={{ period }}&tab=ascent"
       style="
         display:block; padding:8px 10px; border-radius:4px;
         text-decoration:none; margin-bottom:4px;
         {% if tab == 'ascent' %}
           background:#0f172a; color:#f9fafb; font-weight:600;
         {% else %}
           color:#111827;
         {% endif %}
       ">
      D+ max (fen√™tres)
    </a>

    <!-- Onglet VAM -->
    <a href="{{ base_url }}?sport={{ sport }}&period={{ period }}&tab=vam"
       style="
         display:block; padding:8px 10px; border-radius:4px;
         text-decoration:none; margin-bottom:4px;
         {% if tab == 'vam' %}
           background:#0f172a; color:#f9fafb; font-weight:600;
         {% else %}
           color:#111827;
         {% endif %}
       ">
      VAM par pente √ó cardio
    </a>

    <!-- Onglet Allure + projections -->
    <a href="{{ base_url }}?sport={{ sport }}&period={{ period }}&tab=pace"
       style="
         display:block; padding:8px 10px; border-radius:4px;
         text-decoration:none; margin-bottom:4px;
         {% if tab == 'pace' %}
           background:#0f172a; color:#f9fafb; font-weight:600;
         {% else %}
         color:#111827;
         {% endif %}
       ">
      Allure par pente √ó cardio & <span style="color:#dc2626; font-weight:600;">projections Chrono (GPX)</span>
    </a>

    <!-- Onglet Cadence -->
    <a href="{{ base_url }}?sport={{ sport }}&period={{ period }}&tab=cadence"
       style="
         display:block; padding:8px 10px; border-radius:4px;
         text-decoration:none; margin-bottom:4px;
         {% if tab == 'cadence' %}
           background:#0f172a; color:#f9fafb; font-weight:600;
         {% else %}
           color:#111827;
         {% endif %}
       ">
      Cadence par pente √ó cardio
    </a>

    {% if show_glucose_tabs %}
      <!-- Onglet Glyc√©mie -->
      <a href="{{ base_url }}?sport={{ sport }}&period={{ period }}&tab=glucose"
         style="
           display:block; padding:8px 10px; border-radius:4px;
           text-decoration:none; margin-bottom:4px;
           {% if tab == 'glucose' %}
             background:#0f172a; color:#f9fafb; font-weight:600;
           {% else %}
             color:#111827;
           {% endif %}
         ">
        Glyc√©mie (temps dans la zone)
      </a>

      <!-- Onglet Glyc√©mie + activit√©s -->
      <a href="{{ base_url }}?sport={{ sport }}&period={{ period }}&tab=glucose_activities"
         style="
           display:block; padding:8px 10px; border-radius:4px;
           text-decoration:none;
           {% if tab == 'glucose_activities' %}
             background:#0f172a; color:#f9fafb; font-weight:600;
           {% else %}
             color:#111827;
           {% endif %}
         ">
        Glyc√©mie & activit√©s
      </a>
    {% endif %}
  </aside>

  <!-- üß© Colonne droite : contenu -->
  <main>

    <div class="card runner-section {% if tab == 'ascent' %}is-active{% endif %}" style="padding:14px;" data-section="ascent">
        <h3 style="margin:0 0 6px 0; font-size:0.95rem;">Meilleurs D+ par fen√™tre glissante</h3>
        <p class="muted" style="margin:0 0 12px 0; font-size:0.8rem;">
          On parcourt toutes les activit√©s pour trouver l‚Äôheure, les 2h, 5h, 10h et 24h o√π tu as
          grimp√© le plus de d√©nivel√© positif (plut√¥t qu‚Äôune simple activit√© enti√®re).
        </p>

        <div style="overflow-x:auto;">
          <table style="width:100%; border-collapse:collapse; font-size:0.85rem;">
            <thead>
              <tr style="border-bottom:1px solid #e5e7eb;">
                <th style="text-align:left; padding:8px 4px;">Fen√™tre</th>
                <th style="text-align:right; padding:8px 4px;">D+</th>
                <th style="text-align:right; padding:8px 4px;">D-</th>
                <th style="text-align:right; padding:8px 4px;">Distance</th>
                <th style="text-align:right; padding:8px 4px;">D+/h</th>
                <th style="text-align:left; padding:8px 4px;">Activit√©</th>
              </tr>
            </thead>
            <tbody>
              {% for window in best_dplus_windows %}
                <tr style="border-bottom:1px solid #f3f4f6;">
                  <td style="padding:8px 4px;">{{ window.label }}</td>
                  <td style="padding:8px 4px; text-align:right;">
                    {% if window.gain_m and window.gain_m > 0 %}
                      +{{ window.gain_m|round(0)|int }} m
                    {% else %}
                      ‚Äì
                    {% endif %}
                  </td>
                  <td style="padding:8px 4px; text-align:right;">
                    {% if window.loss_m %}
                      -{{ window.loss_m|round(0)|int }} m
                    {% else %}
                      ‚Äì
                    {% endif %}
                  </td>
                  <td style="padding:8px 4px; text-align:right;">
                    {% if window.distance_km %}
                      {{ window.distance_km|round(1) }} km
                    {% else %}
                      ‚Äì
                    {% endif %}
                  </td>
                  <td style="padding:8px 4px; text-align:right;">
                    {% if window.gain_per_hour %}
                      {{ window.gain_per_hour|round(0)|int }} m/h
                    {% else %}
                      ‚Äì
                    {% endif %}
                  </td>
                  <td style="padding:8px 4px;">
                    {% if window.activity_id %}
                      <a href="/ui/user/{{ user.id }}/activity/{{ window.activity_id }}"
                         style="color:#2563eb; text-decoration:none;">
                        D√©tail ‚Üí
                      </a>
                    {% else %}
                      ‚Äì
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

    <div class="card runner-section {% if tab == 'vam' %}is-active{% endif %}" style="padding:14px;" data-section="vam">
        {% if profile.zones and profile.zones|length > 0 %}
          <h3 style="margin:0 0 10px 0; font-size:0.95rem;">
            VAM (m/h) par % de pente et zone cardio
          </h3>
          <p class="muted" style="margin:0 0 10px 0; font-size:0.8rem;">
            Ici on ne regarde que les <strong>pentes positives</strong> (mont√©es).
          </p>

          <table style="width:100%; border-collapse:collapse; font-size:0.8rem;">
            <thead>
              <tr style="border-bottom:1px solid #e5e7eb;">
                <th style="text-align:left; padding:4px 2px;">Pente</th>
                {% for z in hr_zones %}
                  <th style="text-align:right; padding:4px 2px;">
                    {{ z }}<br>
                    <span style="font-weight:400; font-size:0.7rem;">VAM (m/h)</span>
                  </th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for slope_id, slope_label in slopes_order %}
                {% if not slope_id.startswith("Sneg") %} {# ‚ùå exclut pentes n√©gatives #}
                  <tr style="border-bottom:1px solid #f3f4f6;">
                    <td style="padding:4px 2px;">{{ slope_label }}</td>

                    {% for z in hr_zones %}
                      {% set zone = profile.zones.get(z) %}
                      {% if zone %}
                        {% set cell = zone.get(slope_id) %}
                      {% else %}
                        {% set cell = None %}
                      {% endif %}

                      <td style="text-align:right; padding:4px 2px;">
                        {% if cell and cell.avg_vam_m_per_h %}
                          {{ cell.avg_vam_m_per_h|round(0)|int }}
                        {% else %}
                          ‚Äì
                        {% endif %}
                      </td>
                    {% endfor %}
                  </tr>
                {% endif %}
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="muted" style="margin:0;">
            Aucune donn√©e d‚Äôagr√©gats trouv√©e pour ce profil (sport={{ sport }}, p√©riode={{ period }}).
          </p>
        {% endif %}
      </div>

    <div class="card runner-section {% if tab == 'pace' %}is-active{% endif %}" style="padding:14px;" data-section="pace">
        {% if profile.zones and profile.zones|length > 0 %}
          <h3 style="margin:0 0 10px 0; font-size:0.95rem;">
            Allure moyenne (min/km) par % de pente et zone cardio
          </h3>
          <p class="muted" style="margin:0 0 10px 0; font-size:0.8rem;">
            On inclut ici mont√©es <strong>et descentes</strong> pour voir comment tu g√®res
            toutes les pentes.
          </p>

          <table style="width:100%; border-collapse:collapse; font-size:0.8rem;">
            <thead>
              <tr style="border-bottom:1px solid #e5e7eb;">
                <th style="text-align:left; padding:4px 2px;">Pente</th>
                {% for z in hr_zones %}
                  <th style="text-align:right; padding:4px 2px;">
                    {{ z }}<br>
                    <span style="font-weight:400; font-size:0.7rem;">Allure (min/km)</span>
                  </th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for slope_id, slope_label in slopes_order %}
                <tr style="border-bottom:1px solid #f3f4f6;">
                  <td style="padding:4px 2px;">{{ slope_label }}</td>

                  {% for z in hr_zones %}
                    {% set zone = profile.zones.get(z) %}
                    {% if zone %}
                      {% set cell = zone.get(slope_id) %}
                    {% else %}
                      {% set cell = None %}
                    {% endif %}

                    <td style="text-align:right; padding:4px 2px;">
                      {% if cell and cell.avg_pace_s_per_km %}
                        {% set pace_sec = cell.avg_pace_s_per_km|round(0)|int %}
                        {% set pace_min = pace_sec // 60 %}
                        {% set pace_rem = pace_sec % 60 %}
                        {{ pace_min }}'{{ "%02d"|format(pace_rem) }}
                      {% else %}
                        ‚Äì
                      {% endif %}
                    </td>
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="muted" style="margin:0;">
            Aucune donn√©e d‚Äôagr√©gats trouv√©e pour ce profil (sport={{ sport }}, p√©riode={{ period }}).
          </p>
        {% endif %}

        <div class="card" style="margin-top:14px; padding:14px; border:1px solid #fecaca; background:#fee2e2;">
          <h3 style="margin:0 0 6px 0; font-size:0.95rem;">üó∫Ô∏è Projection de chrono sur ta trace GPX</h3>
          <p class="muted" style="margin:0 0 10px 0; font-size:0.8rem;">
            T√©l√©charge ta trace, puis on calcule automatiquement la distance pass√©e dans chaque pente
            et on applique tes allures historiques par zone cardio √ó % de pente pour simuler ton chrono final.
          </p>

          <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
            <input type="file"
                   id="projection-gpx"
                   accept=".gpx"
                   style="flex:1; min-width:200px;"
                   onchange='runSlopeAnalysis({{ user.id }}, {{ sport|tojson }}, {{ period|tojson }})'>
          </div>

          <div id="projection-feedback" style="font-size:0.8rem; color:#0f172a; margin-top:6px;"></div>

          <div id="projection-result" style="margin-top:12px;"></div>
        </div>
      </div>

    <div class="card runner-section {% if tab == 'cadence' %}is-active{% endif %}" style="padding:14px;" data-section="cadence">
        {% if profile.zones and profile.zones|length > 0 %}
          <h3 style="margin:0 0 10px 0; font-size:0.95rem;">
            Cadence de pas (pas/min) par % de pente et zone cardio
          </h3>
          <p class="muted" style="margin:0 0 10px 0; font-size:0.8rem;">
            √áa permet de voir √† quelles pentes tu marches, trottines ou cours.
          </p>

          <table style="width:100%; border-collapse:collapse; font-size:0.8rem;">
            <thead>
              <tr style="border-bottom:1px solid #e5e7eb;">
                <th style="text-align:left; padding:4px 2px;">Pente</th>
                {% for z in hr_zones %}
                  <th style="text-align:right; padding:4px 2px;">
                    {{ z }}<br>
                    <span style="font-weight:400; font-size:0.7rem;">Cadence (pas/min)</span>
                  </th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for slope_id, slope_label in slopes_order %}
                <tr style="border-bottom:1px solid #f3f4f6;">
                  <td style="padding:4px 2px;">{{ slope_label }}</td>

                  {% for z in hr_zones %}
                    {% set zone = profile.zones.get(z) %}
                    {% if zone %}
                      {% set cell = zone.get(slope_id) %}
                    {% else %}
                      {% set cell = None %}
                    {% endif %}

                    <td style="text-align:right; padding:4px 2px;">
                      {% if cell and cell.avg_cadence_spm %}
                        {{ (cell.avg_cadence_spm * 2) | int }}
                      {% else %}
                        ‚Äì
                      {% endif %}
                    </td>
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="muted" style="margin:0;">
            Aucune donn√©e d‚Äôagr√©gats trouv√©e pour ce profil (sport={{ sport }}, p√©riode={{ period }}).
          </p>
        {% endif %}
      </div>

    {% if show_glucose_tabs %}
    <div class="runner-section {% if tab == 'glucose' %}is-active{% endif %}" data-section="glucose">

      <div class="card" style="padding:14px;">
        <h3 style="margin:0 0 6px 0; font-size:0.95rem;">
          Temps pass√© dans chaque zone glyc√©mie
        </h3>
        <p class="muted" style="margin:0 0 12px 0; font-size:0.8rem;">
          Distribution calcul√©e sur les 24 derni√®res heures, 7 jours et 14 jours.
        </p>

        <div style="display:grid; gap:12px; grid-template-columns:repeat(auto-fit, minmax(260px, 1fr));">
          {% for summary in glucose_zone_summary %}
            <div style="border:1px solid #e5e7eb; border-radius:6px; padding:10px; background:#fdfdfd;">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                <strong style="font-size:0.9rem;">{{ summary.label }}</strong>
                <span class="muted" style="font-size:0.75rem;">Total : {{ summary.total_time_str }}</span>
              </div>
              <table style="width:100%; border-collapse:collapse; font-size:0.8rem;">
                <thead>
                  <tr style="border-bottom:1px solid #e5e7eb;">
                    <th style="text-align:left; padding:4px 2px;">Zone</th>
                    <th style="text-align:left; padding:4px 2px;">Plage</th>
                    <th style="text-align:right; padding:4px 2px;">Temps</th>
                    <th style="text-align:right; padding:4px 2px;">% </th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in summary.rows %}
                    <tr style="border-bottom:1px solid #f3f4f6;">
                      <td style="padding:4px 2px; font-weight:600;">{{ row.name }}</td>
                      <td style="padding:4px 2px; color:#0f172a;">{{ row.range }}</td>
                      <td style="padding:4px 2px; text-align:right;">{{ row.time_str }}</td>
                      <td style="padding:4px 2px; text-align:right;">{{ row.percent }}%</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
              <div style="margin-top:8px; font-size:0.85rem; font-weight:600; color:#065f46; background:#d1fae5; padding:6px 8px; border-radius:4px;">
                {% if summary.avg_mgdl %}
                  Glyc√©mie moyenne : {{ summary.avg_mgdl|round(0)|int }} mg/dL
                {% else %}
                  Glyc√©mie moyenne : ‚Äì
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>

        {% set periods_with_data = glucose_zone_summary | selectattr('has_data') | list %}
        {% if periods_with_data|length == 0 %}
          <p class="muted" style="margin-top:12px;">
            Aucune donn√©e glyc√©mie disponible sur ces p√©riodes pour l‚Äôinstant.
          </p>
        {% endif %}
      </div>

      <div class="card" style="padding:14px; margin-top:14px;">
        <h3 style="margin:0 0 6px 0; font-size:0.95rem;">
          Courbe glyc√©mie ‚Äì derni√®res 24 h
        </h3>
        <p class="muted" style="margin:0 0 12px 0; font-size:0.8rem;">
          Visualise l‚Äô√©volution d√©taill√©e point par point.
        </p>

        {% if glucose_chart_24h and glucose_chart_24h|length > 1 %}
          <div style="height:260px;">
            <canvas id="glucose24hChart" height="240"></canvas>
          </div>
        {% else %}
          <p class="muted" style="margin:0;">
            Pas assez de points r√©cents pour dessiner la courbe.
          </p>
        {% endif %}
      </div>

      {% if glucose_chart_24h and glucose_chart_24h|length > 1 %}
        <script>
          (function() {
            const rawPoints = {{ glucose_chart_24h | tojson | safe }};
            if (!rawPoints || rawPoints.length === 0) return;

            const series = rawPoints.map(pt => ({
              x: new Date(pt.ts),
              y: pt.mgdl,
            }));

            const ctx = document.getElementById('glucose24hChart').getContext('2d');

            new Chart(ctx, {
              type: 'line',
              data: {
                datasets: [{
                  label: 'Glyc√©mie (mg/dL)',
                  data: series,
                  borderColor: '#dc2626',
                  backgroundColor: 'rgba(220,38,38,0.12)',
                  tension: 0.2,
                  pointRadius: 0,
                  borderWidth: 2,
                  fill: true,
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                  legend: { display: false },
                  tooltip: {
                    callbacks: {
                      title: items => {
                        const point = items[0].raw;
                        return new Date(point.x).toLocaleString('fr-FR');
                      },
                      label: item => `${item.raw.y.toFixed(0)} mg/dL`,
                    }
                  }
                },
                scales: {
                  x: {
                    type: 'time',
                    time: {
                      unit: 'hour',
                      displayFormats: {
                        hour: 'HH:mm',
                      },
                    },
                    ticks: { maxTicksLimit: 8 },
                    grid: { display: false },
                  },
                  y: {
                    suggestedMin: 60,
                    suggestedMax: 220,
                    grid: { color: '#e5e7eb' },
                    title: {
                      display: true,
                      text: 'mg/dL',
                      color: '#0f172a',
                    },
                  }
                }
              }
            });
          })();
        </script>
      {% endif %}
    </div>

    <div class="runner-section {% if tab == 'glucose_activities' %}is-active{% endif %}" data-section="glucose-activities">
      <div class="card" style="padding:14px;">
        <h3 style="margin:0 0 6px 0; font-size:0.95rem;">Glyc√©mie sur les 20 derni√®res activit√©s</h3>
        <p class="muted" style="margin:0 0 12px 0; font-size:0.8rem;">
          Compare la glyc√©mie au d√©part, la moyenne sur l‚Äôactivit√© et le temps pass√© dans la cible
          (100‚Äì180 mg/dL) pour tes 20 derni√®res sorties {{ sport }} avec donn√©es CGM.
        </p>

        {% if glucose_activity_chart.labels and glucose_activity_chart.labels|length > 0 %}
          <div style="display:flex; flex-direction:column; gap:16px;">
            <div style="border:1px solid #e5e7eb; border-radius:6px; padding:12px;">
              <div style="font-weight:600; margin-bottom:6px;">Glyc√©mie au d√©part</div>
              <div style="height:220px;">
                <canvas id="glucoseStartChart" style="width:100%; height:100%;"></canvas>
              </div>
            </div>
            <div style="border:1px solid #e5e7eb; border-radius:6px; padding:12px;">
              <div style="font-weight:600; margin-bottom:6px;">Glyc√©mie moyenne</div>
              <div style="height:220px;">
                <canvas id="glucoseAvgChart" style="width:100%; height:100%;"></canvas>
              </div>
            </div>
            <div style="border:1px solid #e5e7eb; border-radius:6px; padding:12px;">
              <div style="font-weight:600; margin-bottom:6px;">Temps dans la cible</div>
              <div style="height:220px;">
                <canvas id="glucoseTirChart" style="width:100%; height:100%;"></canvas>
              </div>
            </div>
          </div>
        {% else %}
          <p class="muted" style="margin:0;">Pas encore de donn√©es CGM sur les 20 derni√®res activit√©s.</p>
        {% endif %}
      </div>

      {% if glucose_activity_profile_radar and glucose_activity_profile_radar.has_data %}
        <div class="card" style="padding:14px; margin-top:14px;">
          <h3 style="margin:0 0 6px 0; font-size:0.95rem;">Glyc√©mie moyenne par type d'effort</h3>
          <p class="muted" style="margin:0 0 12px 0; font-size:0.8rem;">
            Classement automatique Endurance / Seuil / Fractionn√© selon le temps pass√© dans chaque zone cardio, puis moyenne des glyc√©mies sur ces sorties.
          </p>
          <div style="max-width:420px; margin:0 auto;">
            <canvas id="glucoseProfileRadar" height="260"></canvas>
          </div>
          <div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; font-size:0.75rem; color:#0f172a;">
            <div>Endurance : {{ glucose_activity_profile_radar.counts[0] }} act.</div>
            <div>Seuil : {{ glucose_activity_profile_radar.counts[1] }} act.</div>
            <div>Fractionn√© : {{ glucose_activity_profile_radar.counts[2] }} act.</div>
          </div>
        </div>
      {% endif %}

      <div class="card" style="padding:14px; margin-top:14px;">
        <h3 style="margin:0 0 6px 0; font-size:0.95rem;">Activit√©s (max 20 affich√©es)</h3>
        <p class="muted" style="margin:0 0 12px 0; font-size:0.8rem;">
          Titre, distance, D+, dur√©e et indicateurs glyc√©mie (d√©part, moyenne, temps dans la cible).
        </p>

        {% if glucose_activity_table %}
          <div style="overflow-x:auto;">
            <table style="width:100%; border-collapse:collapse; font-size:0.85rem;">
              <thead>
                <tr style="border-bottom:1px solid #e5e7eb; text-align:left;">
                  <th style="padding:6px 4px;">Activit√©</th>
                  <th style="padding:6px 4px;">Distance</th>
                  <th style="padding:6px 4px;">D+</th>
                  <th style="padding:6px 4px;">Dur√©e</th>
                  <th style="padding:6px 4px;">D√©part</th>
                  <th style="padding:6px 4px;">Moyenne</th>
                  <th style="padding:6px 4px;">Temps cible</th>
                </tr>
              </thead>
              <tbody>
                {% for row in glucose_activity_table %}
                  <tr style="border-bottom:1px solid #f3f4f6;">
                    <td style="padding:6px 4px;">
                      <div style="font-weight:600;">{{ row.name }}</div>
                      <div class="muted" style="font-size:0.75rem;">{{ row.start_label }}</div>
                    </td>
                    <td style="padding:6px 4px;">
                      {% if row.distance_km is not none %}
                        {{ "%.1f"|format(row.distance_km) }} km
                      {% else %}‚Äì{% endif %}
                    </td>
                    <td style="padding:6px 4px;">
                      {% if row.elevation_gain_m is not none %}
                        {{ row.elevation_gain_m|round(0)|int }} m
                      {% else %}‚Äì{% endif %}
                    </td>
                    <td style="padding:6px 4px;">{{ row.duration_str or "‚Äì" }}</td>
                    <td style="padding:6px 4px;">
                      {% if row.start_glucose is not none %}
                        {{ row.start_glucose|round(0)|int }} mg/dL
                      {% else %}‚Äì{% endif %}
                    </td>
                    <td style="padding:6px 4px;">
                      {% if row.avg_glucose is not none %}
                        {{ row.avg_glucose|round(0)|int }} mg/dL
                      {% else %}‚Äì{% endif %}
                    </td>
                    <td style="padding:6px 4px;">
                      {% if row.tir_percent is not none %}
                        {{ row.tir_percent|round(0)|int }} %
                      {% else %}‚Äì{% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="muted" style="margin:0;">Aucune activit√© enrichie avec glyc√©mie pour l‚Äôinstant.</p>
        {% endif %}
      </div>

      {% if glucose_activity_chart.labels and glucose_activity_chart.labels|length > 0 %}
        <script>
          (function() {
            const chartData = {{ glucose_activity_chart | tojson | safe }};
            if (!chartData || !chartData.labels || chartData.labels.length === 0) return;

            const baseConfig = {
              type: 'line',
              options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: { legend: { display: false } },
                scales: {
                  x: {
                    ticks: { maxRotation: 0 },
                    grid: { display: false },
                  },
                },
              },
            };

            const startCanvas = document.getElementById('glucoseStartChart');
            const avgCanvas = document.getElementById('glucoseAvgChart');
            const tirCanvas = document.getElementById('glucoseTirChart');

            if (!startCanvas || !avgCanvas || !tirCanvas) return;

            const startCtx = startCanvas.getContext('2d');
            const avgCtx = avgCanvas.getContext('2d');
            const tirCtx = tirCanvas.getContext('2d');

            new Chart(startCtx, {
              ...baseConfig,
              data: {
                labels: chartData.labels,
                datasets: [{
                  label: 'D√©part',
                  data: chartData.start,
                  borderColor: '#2563eb',
                  backgroundColor: 'rgba(37,99,235,0.12)',
                  tension: 0.2,
                  fill: true,
                  spanGaps: true,
                }],
              },
              options: {
                ...baseConfig.options,
                scales: {
                  ...baseConfig.options.scales,
                  y: {
                    title: { display: true, text: 'mg/dL' },
                    grid: { color: '#e5e7eb' },
                  },
                },
              },
            });

            new Chart(avgCtx, {
              ...baseConfig,
              data: {
                labels: chartData.labels,
                datasets: [{
                  label: 'Moyenne',
                  data: chartData.avg,
                  borderColor: '#dc2626',
                  backgroundColor: 'rgba(220,38,38,0.12)',
                  tension: 0.2,
                  fill: true,
                  spanGaps: true,
                }],
              },
              options: {
                ...baseConfig.options,
                scales: {
                  ...baseConfig.options.scales,
                  y: {
                    title: { display: true, text: 'mg/dL' },
                    grid: { color: '#e5e7eb' },
                  },
                },
              },
            });

            new Chart(tirCtx, {
              ...baseConfig,
              data: {
                labels: chartData.labels,
                datasets: [{
                  label: 'Temps dans la cible',
                  data: chartData.tir,
                  borderColor: '#059669',
                  backgroundColor: 'rgba(5,150,105,0.12)',
                  tension: 0.2,
                  fill: true,
                  spanGaps: true,
                }],
              },
              options: {
                ...baseConfig.options,
                scales: {
                  ...baseConfig.options.scales,
                  y: {
                    title: { display: true, text: '%' },
                    min: 0,
                    max: 100,
                    grid: { color: '#e5e7eb' },
                  },
                },
              },
            });

            const radarCanvas = document.getElementById('glucoseProfileRadar');
            const radarPayload = {{ glucose_activity_profile_radar | tojson | safe }};
            if (radarCanvas && radarPayload && radarPayload.has_data) {
              const radarCtx = radarCanvas.getContext('2d');
              const bandConfig = [
                { from: 60, to: 70, color: 'rgba(220,38,38,0.2)' },
                { from: 70, to: 180, color: 'rgba(34,197,94,0.18)' },
                { from: 180, to: 250, color: 'rgba(234,179,8,0.18)' },
              ];

              const radarBandsPlugin = {
                id: 'radarBands',
                beforeDraw(chart) {
                  const scale = chart.scales.r;
                  if (!scale) return;
                  const { ctx } = chart;
                  bandConfig.forEach((band) => {
                    const innerR = scale.getDistanceFromCenterForValue(Math.max(band.from, scale.min));
                    const outerR = scale.getDistanceFromCenterForValue(Math.min(band.to, scale.max));
                    if (!isFinite(innerR) || !isFinite(outerR)) return;
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(scale.xCenter, scale.yCenter, outerR, 0, Math.PI * 2);
                    ctx.arc(scale.xCenter, scale.yCenter, innerR, 0, Math.PI * 2, true);
                    ctx.closePath();
                    ctx.fillStyle = band.color;
                    ctx.fill();
                    ctx.restore();
                  });
                },
              };

              new Chart(radarCtx, {
                type: 'radar',
                data: {
                  labels: radarPayload.labels,
                  datasets: [{
                    label: 'Glyc√©mie moyenne (mg/dL)',
                    data: radarPayload.values,
                    backgroundColor: 'rgba(59,130,246,0.15)',
                    borderColor: '#2563eb',
                    borderWidth: 2,
                    pointBackgroundColor: '#2563eb',
                  }],
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: true,
                  scales: {
                    r: {
                      min: 60,
                      max: 250,
                      beginAtZero: false,
                      grid: { color: '#d1d5db' },
                      angleLines: { color: '#d1d5db' },
                      pointLabels: { font: { size: 12 } },
                      ticks: {
                        display: false,
                        showLabelBackdrop: false,
                      },
                    },
                  },
                  plugins: {
                    legend: { display: false },
                  },
                },
                plugins: [radarBandsPlugin],
              });
            }
          })();
        </script>
      {% endif %}
    </div>
    {% endif %}

  </main>
</div>

<script>
  const runnerHrZones = {{ hr_zones | tojson | safe }} || [];
  const runnerPaceLookup = {{ pace_lookup_by_slope | default({}) | tojson | safe }} || {};
  const runnerZoneColors = {
    "Zone 1": "#16a34a",
    "Zone 2": "#22c55e",
    "Zone 3": "#f97316",
    "Zone 4": "#facc15",
    "Zone 5": "#dc2626",
  };
  let projectionKmChart = null;
  const runnerAvgZonePace = (() => {
    const result = {};
    runnerHrZones.forEach(zone => {
      let sum = 0;
      let count = 0;
      Object.values(runnerPaceLookup || {}).forEach(zoneMap => {
        const pace = zoneMap ? zoneMap[zone] : null;
        if (pace && pace > 0) {
          sum += pace;
          count += 1;
        }
      });
      if (count) {
        result[zone] = sum / count;
      }
    });
    return result;
  })();

  function formatProjectionDuration(seconds) {
    if (!seconds || !isFinite(seconds) || seconds <= 0) {
      return "‚Äì";
    }
    const total = Math.round(seconds);
    const hours = Math.floor(total / 3600);
    const minutes = Math.floor((total % 3600) / 60);
    const secs = total % 60;
    if (hours > 0) {
      return `${hours}h${minutes.toString().padStart(2, "0")}`;
    }
    return `${minutes}:${secs.toString().padStart(2, "0")}`;
  }

  function formatMeters(value) {
    if (value === null || value === undefined || !isFinite(value)) return "‚Äì";
    return `${Math.round(value)} m`;
  }

  function formatKilometers(value) {
    if (value === null || value === undefined || !isFinite(value)) return "0.00 km";
    return `${value.toFixed(2)} km`;
  }

  function computeZoneTimesForSplit(segment, paceLookup) {
    const times = {};
    runnerHrZones.forEach(zone => {
      times[zone] = 0;
    });
    if (!segment) return times;
    const pieces = Array.isArray(segment.slope_distribution)
      ? segment.slope_distribution
      : [];
    let processedKm = 0;
    pieces.forEach(piece => {
      const distKm = typeof piece.distance_km === 'number' ? piece.distance_km : 0;
      if (!distKm || !piece.slope_id) return;
      processedKm += distKm;
      const slopePaces = paceLookup[piece.slope_id] || {};
      runnerHrZones.forEach(zone => {
        const pace = slopePaces[zone];
        if (pace && pace > 0) {
          times[zone] += pace * distKm;
        }
      });
    });

    const totalKm = typeof segment.distance_km === 'number' ? segment.distance_km : 0;
    const remainingKm = Math.max(0, totalKm - processedKm);
    if (remainingKm > 1e-4) {
      runnerHrZones.forEach(zone => {
        const fallback = runnerAvgZonePace[zone];
        if (fallback && fallback > 0) {
          times[zone] += fallback * remainingKm;
        }
      });
    }
    return times;
  }

  function renderProjectionKmChart(kmSplits, paceLookup) {
    if (!kmSplits || !kmSplits.length || typeof Chart === "undefined") return;
    const canvas = document.getElementById('projectionKmChart');
    if (!canvas) return;

    const labels = kmSplits.map(seg => `Km ${seg.km_index ?? ''}`);
    const datasets = runnerHrZones.map(zone => {
      const color = runnerZoneColors[zone] || '#2563eb';
      const data = kmSplits.map(segment => {
        const zoneTimes = computeZoneTimesForSplit(segment, paceLookup);
        return (zoneTimes[zone] && segment.distance_km)
          ? zoneTimes[zone]
          : null;
      });
      const hasData = data.some(v => v && v > 0);
      if (!hasData) return null;
      return {
        label: zone,
        data,
        borderColor: color,
        backgroundColor: 'transparent',
        borderWidth: 2,
        tension: 0.25,
        spanGaps: true,
      };
    }).filter(Boolean);

    datasets.forEach(dataset => {
      dataset.pointRadius = 0;
      dataset.pointHoverRadius = 4;
      dataset.pointHitRadius = 6;
    });

    if (!datasets.length) return;

    if (projectionKmChart) {
      projectionKmChart.destroy();
    }

    projectionKmChart = new Chart(canvas.getContext('2d'), {
      type: 'line',
      data: {
        labels,
        datasets,
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        scales: {
          y: {
            title: { display: true, text: 'Temps estim√© par km (s)' },
            ticks: {
              callback: (value) => formatProjectionDuration(value),
            },
            grid: { color: '#e5e7eb' },
          },
          x: {
            ticks: { autoSkip: true, maxRotation: 0 },
            grid: { display: false },
          },
        },
        plugins: {
          legend: {
            position: 'bottom',
          },
          tooltip: {
            callbacks: {
              label: (context) => {
                const zone = context.dataset.label;
                const seconds = context.parsed.y;
                return `${zone}: ${formatProjectionDuration(seconds)}`;
              },
            },
          },
        },
      },
    });
  }

  function toggleDplusDetails(btn) {
    const details = btn.parentElement.querySelector('.dplus-details');
    if (!details) return;
    const show = details.style.display === 'none' || !details.style.display;
    details.style.display = show ? 'block' : 'none';
    btn.textContent = show ? 'Masquer ‚Üê' : 'Voir le d√©tail ‚Üí';
  }

  async function runSlopeAnalysis(userId, sport, period) {
    const fileInput = document.getElementById('projection-gpx');
    const feedback = document.getElementById('projection-feedback');
    const resultBox = document.getElementById('projection-result');

    feedback.textContent = '';
    resultBox.innerHTML = '';

    if (!fileInput || !fileInput.files.length) {
      feedback.textContent = "Merci de s√©lectionner un fichier GPX.";
      return;
    }

    const formData = new FormData();
    formData.append("gpx_file", fileInput.files[0]);
    formData.append("sport", sport);
    formData.append("period", period);

    feedback.textContent = "Calcul en cours...";

    try {
      const response = await fetch(`/ui/user/${userId}/runner-profile/pace-projection`, {
        method: "POST",
        body: formData,
      });

      const data = await response.json();
      if (!response.ok) {
        throw new Error(data.detail || data.error || "Erreur inconnue");
      }

      if (data.slope_distribution && data.slope_distribution.length) {
        const paceLookup = runnerPaceLookup || {};
        const kmSplits = Array.isArray(data.km_splits) ? data.km_splits : [];
        const zoneTotals = {};
        let totalDistance = typeof data.total_distance_km === "number" ? data.total_distance_km : 0;
        if (!totalDistance) {
          totalDistance = data.slope_distribution.reduce(
            (acc, row) => acc + (typeof row.distance_km === "number" ? row.distance_km : 0),
            0
          );
        }

        let html = `
          <h4 style="margin:0 0 4px 0; font-size:0.85rem;">Distance & temps estim√©s par % de pente</h4>
          <p class="muted" style="margin:0 0 8px 0; font-size:0.75rem;">
            Estimation bas√©e sur tes allures moyennes par pente √ó zone cardio.
          </p>
          <table style="width:100%; border-collapse:collapse; font-size:0.75rem; margin-bottom:16px;">
            <thead>
              <tr style="border-bottom:1px solid #e5e7eb;">
                <th style="text-align:left; padding:4px;">Pente</th>
                <th style="text-align:right; padding:4px;">Distance</th>`;
        runnerHrZones.forEach(zone => {
          html += `
                <th style="text-align:right; padding:4px;">
                  ${zone}<br>
                  <span style="font-weight:400; font-size:0.65rem;">Temps estim√©</span>
                </th>`;
        });
        html += `
              </tr>
            </thead>
            <tbody>
        `;
        data.slope_distribution.forEach(row => {
          const dist = typeof row.distance_km === "number" ? row.distance_km : 0;
          html += `
            <tr style="border-bottom:1px solid #f3f4f6;">
              <td style="padding:4px;">${row.label}</td>
              <td style="padding:4px; text-align:right;">${dist.toFixed(2)} km</td>
          `;
          runnerHrZones.forEach(zone => {
            const slopeInfo = paceLookup[row.slope_id] || {};
            const pace = slopeInfo[zone];
            let cellSeconds = null;
            if (pace && dist > 0) {
              cellSeconds = Number(pace) * dist;
              if (cellSeconds > 0) {
                zoneTotals[zone] = (zoneTotals[zone] || 0) + cellSeconds;
              }
            }
            html += `
              <td style="padding:4px; text-align:right;">${formatProjectionDuration(cellSeconds)}</td>
            `;
          });
          html += `
            </tr>
          `;
        });

        html += `
            <tr style="border-top:2px solid #d1d5db; font-weight:600;">
              <td style="padding:4px;">Total</td>
              <td style="padding:4px; text-align:right;">${totalDistance.toFixed(2)} km</td>
        `;
        runnerHrZones.forEach(zone => {
          const totalSec = zoneTotals[zone];
          html += `
              <td style="padding:4px; text-align:right;">${formatProjectionDuration(totalSec)}</td>
          `;
        });
        html += `
            </tr>
            </tbody>
          </table>
        `;

        if (kmSplits.length) {
          const kmZoneTotals = {};
          runnerHrZones.forEach(zone => {
            kmZoneTotals[zone] = 0;
          });
          const totalGain = kmSplits.reduce((acc, seg) => acc + (seg.elevation_gain_m || 0), 0);
          const totalLoss = kmSplits.reduce((acc, seg) => acc + (seg.elevation_loss_m || 0), 0);
          const totalKmDistance = kmSplits.reduce((acc, seg) => acc + (seg.distance_km || 0), 0);

          html += `
            <h4 style="margin:0 0 4px 0; font-size:0.85rem;">Projection km par km</h4>
            <p class="muted" style="margin:0 0 8px 0; font-size:0.75rem;">
              Chaque ligne repr√©sente un kilom√®tre de la trace. On calcule le D+ / D- r√©el et on applique tes allures par zone cardio pour simuler le temps sur ce kilom√®tre.
            </p>
            <div style="overflow-x:auto;">
              <table style="width:100%; border-collapse:collapse; font-size:0.75rem; margin-bottom:12px; min-width:520px;">
                <thead>
                  <tr style="border-bottom:1px solid #e5e7eb;">
                    <th style="text-align:left; padding:4px;">Km</th>
                    <th style="text-align:right; padding:4px;">Km cumul</th>
                    <th style="text-align:right; padding:4px;">Dist.</th>
                    <th style="text-align:right; padding:4px;">D+</th>
                    <th style="text-align:right; padding:4px;">D-</th>`;
          runnerHrZones.forEach(zone => {
            html += `
                    <th style="text-align:right; padding:4px;">${zone}</th>`;
          });
          html += `
                  </tr>
                </thead>
                <tbody>
          `;

          kmSplits.forEach(segment => {
            const zoneTimes = computeZoneTimesForSplit(segment, paceLookup);
            runnerHrZones.forEach(zone => {
              kmZoneTotals[zone] = (kmZoneTotals[zone] || 0) + (zoneTimes[zone] || 0);
            });
            const gainVal = segment.elevation_gain_m ?? 0;
            const lossVal = segment.elevation_loss_m ?? 0;
            html += `
              <tr style="border-bottom:1px solid #f3f4f6;">
                <td style="padding:4px;">${segment.km_index ?? ''}</td>
                <td style="padding:4px; text-align:right;">${formatKilometers(segment.cumulative_km || 0)}</td>
                <td style="padding:4px; text-align:right;">${formatKilometers(segment.distance_km || 0)}</td>
                <td style="padding:4px; text-align:right;">${formatMeters(gainVal)}</td>
                <td style="padding:4px; text-align:right;">${formatMeters(lossVal)}</td>
            `;
            runnerHrZones.forEach(zone => {
              html += `
                <td style="padding:4px; text-align:right;">${formatProjectionDuration(zoneTimes[zone])}</td>
              `;
            });
            html += `
              </tr>
            `;
          });

          html += `
              <tr style="border-top:2px solid #d1d5db; font-weight:600;">
                <td style="padding:4px;">Total</td>
                <td style="padding:4px; text-align:right;">${formatKilometers(totalKmDistance)}</td>
                <td style="padding:4px; text-align:right;">${formatKilometers(totalKmDistance)}</td>
                <td style="padding:4px; text-align:right;">${formatMeters(totalGain)}</td>
                <td style="padding:4px; text-align:right;">${formatMeters(totalLoss)}</td>
          `;
          runnerHrZones.forEach(zone => {
            html += `
                <td style="padding:4px; text-align:right;">${formatProjectionDuration(kmZoneTotals[zone])}</td>
            `;
          });
          html += `
              </tr>
            </tbody>
          </table>
          </div>
          <div style="margin-top:16px; border:1px solid #e5e7eb; border-radius:6px; padding:12px;">
            <div style="font-weight:600; margin-bottom:6px;">Temps estim√© km par km</div>
            <div style="height:320px;">
              <canvas id="projectionKmChart"></canvas>
            </div>
          </div>
          <p class="muted" style="margin:8px 0 0 0; font-size:0.7rem;">La ligne Total doit correspondre au chrono estim√© dans le tableau par pentes.</p>
          `;
        }

        resultBox.innerHTML = html;
        if (kmSplits.length) {
          renderProjectionKmChart(kmSplits, paceLookup);
        }
      } else {
        resultBox.innerHTML = `<p class="muted" style="margin:0;">Aucune portion exploitable sur ce GPX.</p>`;
      }

      feedback.textContent = "";
    } catch (err) {
      feedback.textContent = err.message || "Erreur pendant le calcul.";
      resultBox.innerHTML = "";
    }
  }
</script>

{% endblock %}
