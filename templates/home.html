{% extends "base.html" %}

{% block title %}Dashboard ¬∑ Strava x Glucose{% endblock %}

{% block content %}
  <div class="card">
    <h2>üë• Utilisateurs</h2>
    <p style="color: var(--text-muted); margin-top: -4px;">
      Statut des connexions Strava / LibreLinkUp / Dexcom
    </p>

    {% if users %}
      <table style="width: 100%; border-collapse: collapse; margin-top: 12px;">
        <thead>
          <tr style="border-bottom: 1px solid var(--border); color: var(--text-muted);">
            <th style="text-align:left; padding: 6px;">ID</th>
            <th style="text-align:left; padding: 6px;">Utilisateur</th>
            <th style="text-align:left; padding: 6px;">Strava</th>
            <th style="text-align:left; padding: 6px;">LibreLinkUp</th>
            <th style="text-align:left; padding: 6px;">Dexcom</th>
            <th style="text-align:right; padding: 6px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for u in users %}
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.08);">
              <td style="padding: 6px;">#{{ u.id }}</td>
              <td style="padding: 6px;">{{ u.email }}</td>
              <td style="padding: 6px;">
                {% if u.has_strava %}
                  <span style="color: #4ade80;">Connect√©</span>
                {% else %}
                  <span style="color: #f87171;">Non connect√©</span>
                {% endif %}
              </td>
              <td style="padding: 6px;">
                {% if u.libre_email %}
                  <span style="color: #4ade80;">{{ u.libre_email }}</span>
                {% elif u.has_dexcom %}
                  <span style="color: #facc15;">Dexcom actif</span>
                {% else %}
                  <span style="color: #f87171;">Non configur√©</span>
                {% endif %}
              </td>
              <td style="padding: 6px;">
                {% if u.has_dexcom %}
                  <span style="color: #4ade80;">Connect√©</span>
                {% else %}
                  <span style="color: #f87171;">Non connect√©</span>
                {% endif %}
              </td>
              <td style="text-align:right; padding: 6px;">
                <form method="post" action="/ui/enrich-last" style="display:inline;">
                  <input type="hidden" name="user_id" value="{{ u.id }}">
                  <button type="submit"
                          style="background: var(--accent); color: white; border: none;
                                 border-radius: 6px; padding: 5px 10px; cursor: pointer;">
                    Enrichir
                  </button>
                </form>
                <a href="/ui/user/{{ u.id }}"
                   style="margin-left: 6px; color: var(--accent); font-size: 0.9rem;">
                  Voir
                </a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p style="margin-top: 12px; color: var(--text-muted);">
        Aucun utilisateur enregistr√© pour le moment.<br>
        Cr√©e un utilisateur via <a href="/ui/signup">la page d'inscription</a>.
      </p>
    {% endif %}
  </div>

  <div class="card" style="margin-top:20px;">
    <h3>üïí Derni√®res activit√©s</h3>
    <p style="color: var(--text-muted); margin-top:-4px;">
      Les 30 derni√®res activit√©s (tous utilisateurs) avec leur bloc Strava.
    </p>

    {% if recent_activities %}
      <div style="overflow-x:auto; margin-top:12px;">
        <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
          <thead>
            <tr style="border-bottom:1px solid var(--border); color:var(--text-muted);">
              <th style="text-align:left; padding:6px;">Utilisateur</th>
              <th style="text-align:left; padding:6px;">Activit√©</th>
              <th style="text-align:left; padding:6px;">Date</th>
              <th style="text-align:left; padding:6px;">Type</th>
              <th style="text-align:right; padding:6px;">Distance</th>
              <th style="text-align:right; padding:6px;">Dur√©e</th>
              <th style="text-align:right; padding:6px;">D+</th>
              <th style="text-align:right; padding:6px;">D-</th>
            </tr>
          </thead>
          <tbody>
            {% for row in recent_activities %}
              <tr style="border-bottom:1px solid rgba(255,255,255,0.08);">
                <td style="padding:6px; white-space:nowrap;">#{{ row.user_id }}<br>{{ row.user_email }}</td>
                <td style="padding:6px;">
                  <a href="/ui/user/{{ row.user_id }}/activity/{{ row.id }}"
                     style="color:var(--accent); text-decoration:none;">
                    {{ row.name|truncate(40, True, '‚Ä¶') }}
                  </a>
                </td>
                <td style="padding:6px; white-space:nowrap;">{{ row.date_str }}</td>
                <td style="padding:6px;">{{ row.sport }}</td>
                <td style="padding:6px; text-align:right;">
                  {% if row.distance_km is not none %}{{ row.distance_km }} km{% else %}‚Äì{% endif %}
                </td>
                <td style="padding:6px; text-align:right;">{{ row.duration_str or "‚Äì" }}</td>
                <td style="padding:6px; text-align:right;">
                  {% if row.dplus is not none %}{{ row.dplus }} m{% else %}‚Äì{% endif %}
                </td>
                <td style="padding:6px; text-align:right;">
                  {% if row.dminus is not none %}{{ row.dminus }} m{% else %}‚Äì{% endif %}
                </td>
              </tr>
              <tr style="border-bottom:1px solid rgba(255,255,255,0.08); background:#ffffff;">
                <td colspan="8" style="padding:8px 6px;">
                  {% if row.summary_block %}
                    <div style="font-size:0.8rem; color:#0f172a; white-space:pre-line; max-height:180px; overflow:auto;">
                      {{ row.summary_block }}
                    </div>
                  {% else %}
                    <span style="color:#6b7280;">‚Äî Aucun commentaire Strava</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p style="margin-top:12px; color:var(--text-muted);">
        Aucune activit√© r√©cente.
      </p>
    {% endif %}
  </div>

  <div class="card">
    <h3>‚ÑπÔ∏è Aide rapide</h3>
    <ul style="color: var(--text-muted); line-height: 1.5;">
      <li>1Ô∏è‚É£ Cr√©e un utilisateur (email + mot de passe).</li>
      <li>2Ô∏è‚É£ Connecte ton compte Strava via le flux OAuth.</li>
      <li>3Ô∏è‚É£ Configure ton compte LibreLinkUp.</li>
      <li>4Ô∏è‚É£ Clique sur <em>‚ÄúEnrichir‚Äù</em> pour r√©cup√©rer la glyc√©mie et la lier √† la derni√®re activit√© Strava.</li>
    </ul>
  </div>
{% endblock %}
