{% extends "base.html" %}

{% block title %}Dashboard Â· {{ user.email }}{% endblock %}

{% block extra_head %}
<style>
  .dashboard-grid {
    display:grid;
    grid-template-columns:repeat(2, minmax(0, 1fr));
    gap:16px;
    margin-bottom:20px;
  }
  @media (max-width: 900px) {
    .dashboard-grid {
      grid-template-columns:1fr;
    }
  }
  .dashboard-activities-grid {
    display:grid;
    grid-template-columns:minmax(0, 1fr) minmax(0, 1fr);
    gap:16px;
  }
  @media (max-width: 1100px) {
    .dashboard-activities-grid {
      grid-template-columns:minmax(0, 1fr);
    }
  }
  @media (max-width: 720px) {
    .dashboard-activities-grid {
      grid-template-columns:1fr;
    }
  }
</style>
{% endblock %}

{% block content %}

<!-- ========================================================= -->
<!-- ğŸ§ En-tÃªte utilisateur (avatar ovale dorÃ© style vieux tableau) -->
<!-- ========================================================= -->
<div style="
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:16px 0 12px;
  border-bottom:1px solid var(--border-soft);
  margin-bottom:16px;
">
  <div style="display:flex; align-items:center; gap:14px;">
    <div>
      <div style="font-size:1.1rem; font-weight:600; color:var(--text-main);">
        {% if user.first_name or user.last_name %}
          {{ user.first_name or "" }} {{ user.last_name or "" }}
        {% else %}
          {{ user.email }}
        {% endif %}
      </div>
      <!-- div style="font-size:0.9rem; color:var(--text-muted); margin-top:2px;">Dashboard Â· id={{ user.id }}</div> -->
      <div style="font-size:0.8rem; color:#9ca3af; margin-top:2px;">
        {% if user.location %}{{ user.location }}{% else %}Localisation non renseignÃ©e{% endif %}
      </div>
    </div>
  </div>

  <div style="display:flex; gap:8px;"><!-- header actions removed, now in global nav --></div>
</div>

<!-- ========================================================= -->
<!-- Profil coureur + bloc activitÃ©s (desktop only) -->
<!-- ========================================================= -->
<div class="dashboard-grid" style="position:relative; z-index:0;">

  <div class="card">
    <h2 style="font-size:1rem; font-weight:600; margin-bottom:7px;">ğŸƒ Profil Coureur / Traileur</h2>
    <p class="muted" style="margin-top:0; font-size:0.85rem;">
      Profil cardio Ã— pente Ã— VAM Ã— cadence Ã— allure + projections chrono depuis un GPX (Trail / Route).
    </p>

    <div style="margin-top:12px; text-align:right;">
      <a href="/ui/user/{{ user.id }}/runner-profile"
        style="
            display:inline-block;
            padding:10px 16px;
            background:var(--grad-accent);
            color:white;
            text-decoration:none;
            border-radius:4px;
            font-weight:600;
            box-shadow:0 6px 16px rgba(37,99,235,.25);
            transition:filter .15s ease;
        "
        onmouseover="this.style.filter='brightness(1.05)'"
        onmouseout="this.style.filter='none'">
        ğŸ“ˆ Voir ton profil
      </a>
    </div>
  </div>

  <div class="card">
    <div id="anchor-vam" style="position:relative; top:-80px;"></div>
    <h2 style="font-size:1rem; font-weight:600; margin-bottom:6px;">ğŸ“š ActivitÃ©s</h2>
    <p class="muted" style="margin-top:0; font-size:0.85rem;">
      Consulte les 30 derniÃ¨res activitÃ©s enrichies : distance, D+/D-, fenÃªtres D+ et glycÃ©mie.
    </p>
    <div style="margin-top:12px; text-align:right;">
      <a href="/ui/user/{{ user.id }}/activities"
         style="
           display:inline-block;
           padding:10px 16px;
           background:var(--grad-accent);
           color:white;
           text-decoration:none;
           border-radius:4px;
           font-weight:600;
           box-shadow:0 6px 16px rgba(37,99,235,.25);
           transition:filter .15s ease;
         "
         onmouseover="this.style.filter='brightness(1.05)'"
         onmouseout="this.style.filter='none'">
        ğŸ“„ AccÃ©der aux activitÃ©s
      </a>
    </div>
  </div>
</div>

<!-- ================== DERNIÃˆRES ACTIVITÃ‰S (split map | VAM) ================== -->
<div class="dashboard-activities-grid">
{% for a in last_activities %}
  <div class="card"
     style="
       position:relative;
       overflow:visible;
       border:2px solid {{ a.level_color }};
       border-radius:6px;
     ">

    {% if a.level %}
      <!-- Badge niveau losange -->
      <div style="
        position:absolute;
        top:-10px;
        right:10px;
        display:flex;
        flex-direction:column;
        align-items:center;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      ">
        <div style="position:relative; width:75px; height:60px;">
          <!-- Contour blanc + ombre -->
          <div style="
            position:absolute;
            inset:0;
            clip-path: polygon(50% 0, 92% 40%, 70% 100%, 30% 100%, 8% 40%);
            background:#ffffff;
            box-shadow:0 4px 12px rgba(15,23,42,0.35);
            border-radius:2px;
          "></div>

          <!-- IntÃ©rieur colorÃ© -->
            <div style="
                position:absolute;
                inset:3px;
                clip-path: polygon(50% 0, 92% 40%, 70% 100%, 30% 100%, 8% 40%);
                background: {{ a.level_color or '#6b7280' }};
                display:flex;
                flex-direction:column;
                align-items:center;
                justify-content:center;
                color:#ffffff;
                font-weight:700;
                text-transform:uppercase;

                /* ğŸ‘‰ Tu peux ajuster ici le texte du losang */
                padding-top:10px;
                padding-bottom:4px;
                padding-left:4px;
                padding-right:4px;
            ">
            <div style="font-size:0.55rem; letter-spacing:0.06em; opacity:0.9;">
              Niveau
            </div>
            <div style="font-size:1.05rem; line-height:1; margin-top:2px;">
              {{ a.level }}
            </div>
          </div>
        </div>

        <!-- Label sortie sous le losange -->
        <div style="
          margin-top:4px;
          font-size:0.65rem;
          text-transform:uppercase;
          letter-spacing:0.06em;
          color:#6b7280;
        ">
          Sortie
        </div>
      </div>
    {% endif %}

    <h3 style="margin:0;">
      <a href="/ui/user/{{ user.id }}/activity/{{ a.id }}">
        {% set sport = (a.sport or '')|lower %}
        {% if sport in ['run', 'trailrun', 'trail run'] %}
          ğŸƒ
        {% elif sport in ['ride', 'virtualride', 'ebikeride', 'gravelride', 'mountainbike', 'mtb'] %}
          ğŸš´
        {% elif sport in ['ski_alpine', 'ski', 'alpineski', 'backcountryski'] %}
          ğŸ¿
        {% elif sport in ['ski_nordic', 'rollerski'] %}
          â›·ï¸
        {% elif sport in ['hike', 'walk'] %}
          ğŸš¶
        {% else %}
          âšª
        {% endif %}
        {{ (a.name or ('ActivitÃ© #' ~ a.id))|truncate(60, True, 'â€¦') }}
      </a>
    </h3>
    <p class="muted" style="margin:4px 0 12px;">
      {{ a.date_str }} Â· {{ a.dist_km }} km Â· D+ {{ a.dplus }} m Â·
      DurÃ©e {{ (a.duration_sec // 3600)|int }}h{{ ((a.duration_sec % 3600) // 60)|int }} Â·
      {% if a.tir_percent is not none %}TIR {{ a.tir_percent|round(0) }}%{% else %}TIR n/a{% endif %}
    </p>

    <div style="display:grid; grid-template-columns: minmax(0, 2fr) minmax(0, 1fr); gap:36px;">
      <!-- Carte Ã  gauche -->
      <div id="map-{{ a.id }}" style="height: 240px; border:1px solid #eee; border-radius:2px;"></div>

      <!-- ğŸ“¤ Bloc envoyÃ© sur Strava -->
      <div style="margin-top:12px;">
        {% if a.summary_block_clean %}
          <pre style="background:#ffffff; color:#0f172a; padding:10px; border-radius:4px;
                      border:1px solid #e5e7eb; font-size:0.8rem; line-height:1.5;
                      white-space:pre-wrap; max-height:220px; overflow:auto;">
{{ a.summary_block_clean }}
          </pre>
        {% else %}
          <div style="font-size:0.85rem; color:#9ca3af;">Aucun bloc gÃ©nÃ©rÃ© pour cette activitÃ©.</div>
        {% endif %}
      </div>
    </div>

    <script>
      (function(){
        const pts = {{ a.gps|tojson }};
        if (pts && pts.length > 1 && window.L) {
          const map = L.map('map-{{ a.id }}', { zoomControl: false });
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
          }).addTo(map);
          const poly = L.polyline(pts, { weight: 3 }).addTo(map);
          map.fitBounds(poly.getBounds(), { padding: [20, 20] });
        }
      })();
    </script>
  </div>
{% endfor %}
</div>

<script>
  try {
    const dbg = {{ debug_js|safe }};
    console.log("Dashboard data:", dbg);
  } catch (e) {}
</script>

{% endblock %}
