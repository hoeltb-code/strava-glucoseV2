{% extends "base.html" %}

{% block title %}Dashboard ¬∑ {{ user.email }}{% endblock %}

{% block extra_head %}
<style>
  .dashboard-grid {
    display:grid;
    grid-template-columns:repeat(2, minmax(0, 1fr));
    gap:16px;
    margin-bottom:20px;
  }
  @media (max-width: 900px) {
    .dashboard-grid {
      grid-template-columns:1fr;
    }
  }
  .dashboard-activities-grid {
    display:flex;
    flex-direction:column;
    gap:16px;
  }
  .insight-list {
    list-style:none;
    padding-left:0;
    margin:0;
  }
  .insight-list li {
    margin-bottom:4px;
    font-size:0.85rem;
  }
  .mini-table {
    width:100%;
    border-collapse:collapse;
    font-size:0.85rem;
    margin-top:8px;
  }
  .mini-table th,
  .mini-table td {
    padding:4px 6px;
    border-bottom:1px solid #e5e7eb;
  }
</style>
{% endblock %}

{% block content %}

<!-- ========================================================= -->
<!-- üßç En-t√™te utilisateur (avatar ovale dor√© style vieux tableau) -->
<!-- ========================================================= -->
<div style="
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:16px 0 12px;
  border-bottom:1px solid var(--border-soft);
  margin-bottom:16px;
">
  <div style="display:flex; align-items:center; gap:14px;">
    <div>
      <div style="font-size:1.1rem; font-weight:600; color:var(--text-main);">
        {% if user.first_name or user.last_name %}
          {{ user.first_name or "" }} {{ user.last_name or "" }}
        {% else %}
          {{ user.email }}
        {% endif %}
      </div>
      <!-- div style="font-size:0.9rem; color:var(--text-muted); margin-top:2px;">Dashboard ¬∑ id={{ user.id }}</div> -->
      <div style="font-size:0.8rem; color:#9ca3af; margin-top:2px;">
        {% if user.location %}{{ user.location }}{% else %}Localisation non renseign√©e{% endif %}
      </div>
    </div>
  </div>

  <div style="display:flex; gap:8px;"><!-- header actions removed, now in global nav --></div>
</div>

<div class="card" style="padding:12px 16px; margin-bottom:14px;">
  <p style="margin:0; font-size:0.9rem; color:#0f172a;">
    Strava x D+ est le cockpit des amoureux de D+ : VAM, projections de course, analyse fine de tes traces
    GPX et stats pouss√©es pour comprendre et progresser. Tu peux aussi y ajouter le suivi glyc√©mie avec ton
    capteur CGM.
  </p>
</div>

{% if fc_info or sport_distribution or vam_highlights or dash_distance_projections %}
<div class="dashboard-grid">
  {% if fc_info %}
  <div class="card">
    <h2 style="font-size:1rem; font-weight:600; margin-bottom:7px;">‚ù§Ô∏è Bases cardio & capteurs</h2>
    <p style="margin:0 0 6px 0; font-size:0.85rem;">
      FC max actuelle :
      <strong>{{ fc_info.fc_max }} bpm</strong>
      <span style="color:#6b7280;">({{ fc_info.source }})</span>
    </p>
    {% if fc_info.needs_update %}
      <p style="margin:0 0 8px 0; font-size:0.8rem; color:#b45309;">
        Cette valeur conditionne les zones cardio du profil coureur ‚Äì
        v√©rifie-la dans ton <a href="/ui/user/{{ user.id }}/profile">profil utilisateur</a>.
      </p>
    {% endif %}

    <table class="mini-table" style="margin-top:10px;">
      <thead>
        <tr>
          <th style="text-align:left;">Zone</th>
          <th style="text-align:center;">Plage</th>
          <th style="text-align:right;">BPM</th>
        </tr>
      </thead>
      <tbody>
        {% for zone in fc_info.zones %}
        <tr>
          <td>{{ zone.label }}</td>
          <td style="text-align:center;">{{ zone.percent_label }}</td>
          <td style="text-align:right;">{{ zone.bpm_min }} - {{ zone.bpm_max }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    {% if fc_info.recent_usage and fc_info.recent_usage.total_seconds > 0 %}
    <div style="margin-top:16px;">
      <div style="font-size:0.85rem; font-weight:600;">
        Temps pass√© par zone ({{ fc_info.recent_usage.window_days }} derniers jours)
      </div>
      <table class="mini-table" style="margin-top:6px;">
        <thead>
          <tr>
            <th style="text-align:left;">Zone</th>
            <th style="text-align:center;">Dur√©e</th>
            <th style="text-align:right;">%</th>
            <th style="text-align:left;">Visuel</th>
          </tr>
        </thead>
        <tbody>
          {% for usage in fc_info.recent_usage.zones %}
          <tr>
            <td>{{ usage.label }}</td>
            <td style="text-align:center;">{{ usage.duration_str }}</td>
            <td style="text-align:right;">{{ usage.percent|round(1) }}%</td>
            <td>
              <div style="background:#e5e7eb; border-radius:999px; height:6px; overflow:hidden;">
                <div style="width:{{ usage.percent }}%; height:100%; background:#2563eb;"></div>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}

  </div>
  {% endif %}

  {% if sport_distribution or vam_highlights or dash_distance_projections %}
  <div class="card">
    <h2 style="font-size:1rem; font-weight:600; margin-bottom:7px;">üìä Tendances d'entra√Ænement</h2>

    {% if sport_distribution %}
    <div style="margin-bottom:10px;">
      <div style="font-size:0.85rem; font-weight:600;">R√©partition des sports (28 derniers jours)</div>
      <table class="mini-table">
        <thead>
          <tr>
            <th style="text-align:left;">Sport</th>
            <th style="text-align:center;">% temps</th>
            <th style="text-align:right;">Distance</th>
            <th style="text-align:right;">Dur√©e</th>
            <th style="text-align:right;">D+</th>
          </tr>
        </thead>
        <tbody>
          {% for sport in sport_distribution %}
          <tr>
            <td>{{ sport.emoji }} {{ sport.label }}</td>
            <td style="text-align:center;">{{ sport.percent_time|round(1) }}%</td>
            <td style="text-align:right;">{{ sport.distance_km|round(1) }} km</td>
            <td style="text-align:right;">{{ sport.duration_str }}</td>
            <td style="text-align:right;">{{ sport.dplus_m|round(0) }} m</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}

    {% if vam_highlights %}
    <div style="margin-bottom:10px;">
      <div style="font-size:0.85rem; font-weight:600; color:#dc2626;">
        Fen√™tres D+ / VAM records (Running)
      </div>
      <table class="mini-table">
        <thead>
          <tr><th style="text-align:left;">Fen√™tre</th><th style="text-align:right;">D+</th><th style="text-align:right;">VAM</th></tr>
        </thead>
        <tbody>
          {% for win in vam_highlights %}
          <tr>
            <td>{{ win.label }}</td>
            <td style="text-align:right;">{{ win.gain_m|round(0) }} m</td>
            <td style="text-align:right;">{{ win.vam|round(0) if win.vam else "n/a" }} m/h</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}

    {% if dash_distance_projections %}
    <div>
      <div style="font-size:0.85rem; font-weight:600;">Projections chrono route</div>
      <table class="mini-table">
        <thead>
          <tr><th style="text-align:left;">Distance</th><th style="text-align:center;">Allure</th><th style="text-align:right;">Chrono</th></tr>
        </thead>
        <tbody>
          {% for proj in dash_distance_projections %}
          <tr>
            <td>{{ proj.label }}</td>
            <td style="text-align:center;">
              {% if proj.available %}
                {{ proj.pace_str }}
              {% else %}
                n/a
              {% endif %}
            </td>
            <td style="text-align:right;">
              {% if proj.available %}
                {{ proj.chrono_str }}
              {% else %}
                {{ proj.reason }}
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}
  </div>
  {% endif %}
</div>
{% endif %}

<!-- ================== DERNI√àRES ACTIVIT√âS (split map | VAM) ================== -->
<div class="dashboard-activities-grid">
{% for a in last_activities %}
  <div class="card" style="border:1px solid #e5e7eb; border-radius:6px; padding:12px;">
    <div style="font-weight:600; font-size:1rem;">
      <a href="/ui/user/{{ user.id }}/activity/{{ a.id }}" style="text-decoration:none; color:inherit;">
        {% set sport = (a.sport or '')|lower %}
        {% if sport in ['run', 'trailrun', 'trail run'] %}
          üèÉ
        {% elif sport in ['ride', 'virtualride', 'ebikeride', 'gravelride', 'mountainbike', 'mtb'] %}
          üö¥
        {% elif sport in ['ski_alpine', 'ski', 'alpineski', 'backcountryski'] %}
          üéø
        {% elif sport in ['ski_nordic', 'rollerski'] %}
          ‚õ∑Ô∏è
        {% elif sport in ['hike', 'walk'] %}
          üö∂
        {% else %}
          ‚ö™
        {% endif %}
        {{ (a.name or ('Activit√© #' ~ a.id))|truncate(60, True, '‚Ä¶') }}
      </a>
    </div>
    <div style="font-size:0.85rem; color:#0f172a; margin-top:4px;">
      {{ a.date_str }} ¬∑ {{ a.dist_km }} km ¬∑ D+ {{ a.dplus }} m ¬∑
      Dur√©e {{ (a.duration_sec // 3600)|int }}h{{ ((a.duration_sec % 3600) // 60)|int }} ¬∑
      {% if a.tir_percent is not none %}TIR {{ a.tir_percent|round(0) }}%{% else %}TIR n/a{% endif %}
    </div>

    <div style="display:flex; flex-wrap:wrap; gap:16px; margin-top:12px;">
      <div style="flex:0 0 220px;">
        <div id="map-{{ a.id }}" style="height:160px; border:1px solid #e5e7eb; border-radius:4px;"></div>
      </div>
      <div style="flex:1 1 320px;">
        {% if a.summary_block_clean %}
          <div style="background:#ffffff; color:#0f172a; padding:10px; border-radius:4px;
                      border:1px solid transparent; font-size:0.85rem; line-height:1.5;
                      white-space:pre-wrap; font-family:inherit;">
            {{ a.summary_block_clean }}
          </div>
        {% else %}
          <div style="font-size:0.85rem; color:#9ca3af;">Aucun bloc g√©n√©r√© pour cette activit√©.</div>
        {% endif %}
      </div>
    </div>

    <script>
      (function(){
        const pts = {{ a.gps|tojson }};
        if (pts && pts.length > 1 && window.L) {
          const map = L.map('map-{{ a.id }}', {
            zoomControl: false,
            dragging: false,
            scrollWheelZoom: false,
            doubleClickZoom: false,
            boxZoom: false,
            keyboard: false,
            tap: false,
            touchZoom: false
          });
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
          }).addTo(map);
          const poly = L.polyline(pts, { weight: 3 }).addTo(map);
          map.fitBounds(poly.getBounds(), { padding: [20, 20] });
        }
      })();
    </script>
  </div>
{% endfor %}
</div>

<script>
  try {
    const dbg = {{ debug_js|safe }};
    console.log("Dashboard data:", dbg);
  } catch (e) {}
</script>

{% endblock %}
