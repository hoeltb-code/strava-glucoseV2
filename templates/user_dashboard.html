{% extends "base.html" %}

{% block title %}Dashboard Â· {{ user.email }}{% endblock %}

{% block extra_head %}
<style>
  .dashboard-grid {
    display:grid;
    grid-template-columns:repeat(2, minmax(0, 1fr));
    gap:16px;
    margin-bottom:20px;
  }
  @media (max-width: 900px) {
    .dashboard-grid {
      grid-template-columns:1fr;
    }
  }
  .dashboard-activities-grid {
    display:flex;
    flex-direction:column;
    gap:16px;
  }
</style>
{% endblock %}

{% block content %}

<!-- ========================================================= -->
<!-- ğŸ§ En-tÃªte utilisateur (avatar ovale dorÃ© style vieux tableau) -->
<!-- ========================================================= -->
<div style="
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:16px 0 12px;
  border-bottom:1px solid var(--border-soft);
  margin-bottom:16px;
">
  <div style="display:flex; align-items:center; gap:14px;">
    <div>
      <div style="font-size:1.1rem; font-weight:600; color:var(--text-main);">
        {% if user.first_name or user.last_name %}
          {{ user.first_name or "" }} {{ user.last_name or "" }}
        {% else %}
          {{ user.email }}
        {% endif %}
      </div>
      <!-- div style="font-size:0.9rem; color:var(--text-muted); margin-top:2px;">Dashboard Â· id={{ user.id }}</div> -->
      <div style="font-size:0.8rem; color:#9ca3af; margin-top:2px;">
        {% if user.location %}{{ user.location }}{% else %}Localisation non renseignÃ©e{% endif %}
      </div>
    </div>
  </div>

  <div style="display:flex; gap:8px;"><!-- header actions removed, now in global nav --></div>
</div>

<!-- ========================================================= -->
<!-- Profil coureur + bloc activitÃ©s (desktop only) -->
<!-- ========================================================= -->
<div class="dashboard-grid" style="position:relative; z-index:0;">

  <div class="card">
    <h2 style="font-size:1rem; font-weight:600; margin-bottom:7px;">ğŸƒ Profil Coureur / Traileur</h2>
    <p class="muted" style="margin-top:0; font-size:0.85rem;">
      Profil cardio Ã— pente Ã— VAM Ã— cadence Ã— allure + projections chrono depuis un GPX (Trail / Route).
    </p>

    <div style="margin-top:12px; text-align:right;">
      <a href="/ui/user/{{ user.id }}/runner-profile"
        style="
            display:inline-block;
            padding:10px 16px;
            background:var(--grad-accent);
            color:white;
            text-decoration:none;
            border-radius:4px;
            font-weight:600;
            box-shadow:0 6px 16px rgba(37,99,235,.25);
            transition:filter .15s ease;
        "
        onmouseover="this.style.filter='brightness(1.05)'"
        onmouseout="this.style.filter='none'">
        ğŸ“ˆ Voir ton profil
      </a>
    </div>
  </div>

  <div class="card">
    <div id="anchor-vam" style="position:relative; top:-80px;"></div>
    <h2 style="font-size:1rem; font-weight:600; margin-bottom:6px;">ğŸ“š ActivitÃ©s</h2>
    <p class="muted" style="margin-top:0; font-size:0.85rem;">
      Consulte les 30 derniÃ¨res activitÃ©s enrichies : distance, D+/D-, fenÃªtres D+ et glycÃ©mie.
    </p>
    <div style="margin-top:12px; text-align:right;">
      <a href="/ui/user/{{ user.id }}/activities"
         style="
           display:inline-block;
           padding:10px 16px;
           background:var(--grad-accent);
           color:white;
           text-decoration:none;
           border-radius:4px;
           font-weight:600;
           box-shadow:0 6px 16px rgba(37,99,235,.25);
           transition:filter .15s ease;
         "
         onmouseover="this.style.filter='brightness(1.05)'"
         onmouseout="this.style.filter='none'">
        ğŸ“„ AccÃ©der aux activitÃ©s
      </a>
    </div>
  </div>
</div>

<!-- ================== DERNIÃˆRES ACTIVITÃ‰S (split map | VAM) ================== -->
<div class="dashboard-activities-grid">
{% for a in last_activities %}
  <div class="card" style="border:1px solid #e5e7eb; border-radius:6px; padding:12px;">
    <div style="font-weight:600; font-size:1rem;">
      <a href="/ui/user/{{ user.id }}/activity/{{ a.id }}" style="text-decoration:none; color:inherit;">
        {% set sport = (a.sport or '')|lower %}
        {% if sport in ['run', 'trailrun', 'trail run'] %}
          ğŸƒ
        {% elif sport in ['ride', 'virtualride', 'ebikeride', 'gravelride', 'mountainbike', 'mtb'] %}
          ğŸš´
        {% elif sport in ['ski_alpine', 'ski', 'alpineski', 'backcountryski'] %}
          ğŸ¿
        {% elif sport in ['ski_nordic', 'rollerski'] %}
          â›·ï¸
        {% elif sport in ['hike', 'walk'] %}
          ğŸš¶
        {% else %}
          âšª
        {% endif %}
        {{ (a.name or ('ActivitÃ© #' ~ a.id))|truncate(60, True, 'â€¦') }}
      </a>
    </div>
    <div style="font-size:0.85rem; color:#6b7280; margin-top:4px;">
      {{ a.date_str }} Â· {{ a.dist_km }} km Â· D+ {{ a.dplus }} m Â·
      DurÃ©e {{ (a.duration_sec // 3600)|int }}h{{ ((a.duration_sec % 3600) // 60)|int }} Â·
      {% if a.tir_percent is not none %}TIR {{ a.tir_percent|round(0) }}%{% else %}TIR n/a{% endif %}
    </div>

    <div style="display:flex; flex-wrap:wrap; gap:16px; margin-top:12px;">
      <div style="flex:0 0 220px;">
        <div id="map-{{ a.id }}" style="height:160px; border:1px solid #e5e7eb; border-radius:4px;"></div>
      </div>
      <div style="flex:1 1 320px;">
        {% if a.summary_block_clean %}
          <pre style="background:#ffffff; color:#0f172a; padding:10px; border-radius:4px;
                      border:1px solid transparent; font-size:0.8rem; line-height:1.5;
                      white-space:pre-wrap; max-height:200px; overflow:auto;">
{{ a.summary_block_clean }}
          </pre>
        {% else %}
          <div style="font-size:0.85rem; color:#9ca3af;">Aucun bloc gÃ©nÃ©rÃ© pour cette activitÃ©.</div>
        {% endif %}
      </div>
    </div>

    <script>
      (function(){
        const pts = {{ a.gps|tojson }};
        if (pts && pts.length > 1 && window.L) {
          const map = L.map('map-{{ a.id }}', { zoomControl: false });
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
          }).addTo(map);
          const poly = L.polyline(pts, { weight: 3 }).addTo(map);
          map.fitBounds(poly.getBounds(), { padding: [20, 20] });
        }
      })();
    </script>
  </div>
{% endfor %}
</div>

<script>
  try {
    const dbg = {{ debug_js|safe }};
    console.log("Dashboard data:", dbg);
  } catch (e) {}
</script>

{% endblock %}
