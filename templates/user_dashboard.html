{% extends "base.html" %}

{% block title %}Dashboard ¬∑ {{ user.email }}{% endblock %}

{% block extra_head %}
<style>
  .dashboard-grid {
    display:grid;
    grid-template-columns:minmax(0, 1fr);
    gap:16px;
    margin-bottom:20px;
  }
  .dashboard-activities-grid {
    display:grid;
    grid-template-columns:minmax(0, 1fr) minmax(0, 1fr);
    gap:16px;
  }
  @media (max-width: 1100px) {
    .dashboard-activities-grid {
      grid-template-columns:minmax(0, 1fr);
    }
  }
  @media (max-width: 720px) {
    .mobile-hide-dashboard {
      display: none !important;
    }
    .dashboard-activities-grid {
      grid-template-columns:1fr;
    }
  }
</style>
{% endblock %}

{% block content %}

<!-- ========================================================= -->
<!-- üßç En-t√™te utilisateur (avatar ovale dor√© style vieux tableau) -->
<!-- ========================================================= -->
<div style="
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:16px 0 12px;
  border-bottom:1px solid var(--border-soft);
  margin-bottom:16px;
">
  <div style="display:flex; align-items:center; gap:14px;">
    {% if user.profile_image_url %}
    <div style="position:relative; width:70px; height:90px; flex-shrink:0;
                transform: rotate(9deg);">

    <!-- Cadre dor√© ovale -->
    <div style="
        position:absolute;
        inset:0;
        border-radius:50% / 58%;
        background:
            radial-gradient(circle at 30% 30%, #f7e7b0, #d4b469, #a07c36),
            linear-gradient(145deg, rgba(255,255,255,0.5), rgba(0,0,0,0.3));
        background-blend-mode:overlay;
        box-shadow:
            inset 0 1px 2px rgba(255,255,255,0.7),
            inset 0 -2px 4px rgba(0,0,0,0.35),
            0 4px 10px rgba(0,0,0,0.35);
        padding:4px;
        ">
    </div>

    <!-- Int√©rieur ovale -->
    <div style="
        position:absolute;
        top:4px; left:4px;
        width:calc(100% - 8px);
        height:calc(100% - 8px);
        border-radius:50% / 58%;
        overflow:hidden;
        background:#fff;
        ">
        <img src="{{ user.profile_image_url }}"
            alt="Avatar"
            style="width:100%; height:100%; object-fit:cover;">
    </div>
    </div>
    {% else %}
    <div style="position:relative; width:70px; height:90px; flex-shrink:0;
                transform: rotate(-3deg);">

    <!-- Cadre dor√© ovale -->
    <div style="
        position:absolute;
        inset:0;
        border-radius:50% / 58%;
        background:
            radial-gradient(circle at 30% 30%, #f7e7b0, #d4b469, #a07c36),
            linear-gradient(145deg, rgba(255,255,255,0.5), rgba(0,0,0,0.3));
        background-blend-mode:overlay;
        box-shadow:
            inset 0 1px 2px rgba(255,255,255,0.7),
            inset 0 -2px 4px rgba(0,0,0,0.35),
            0 4px 10px rgba(0,0,0,0.35);
        padding:4px;
        ">
    </div>

    <!-- Int√©rieur + initiale -->
    <div style="
        position:absolute;
        top:4px; left:4px;
        width:calc(100% - 8px);
        height:calc(100% - 8px);
        border-radius:50% / 58%;
        display:flex; align-items:center; justify-content:center;
        background:#fff;
        color:#111827;
        font-weight:700;
        font-size:1.3rem;
        ">
        {% if user.first_name %}
        {{ user.first_name[0]|upper }}
        {% else %}
        {{ user.email[0]|upper }}
        {% endif %}
    </div>
    </div>
    {% endif %}

    <div>
      <div style="font-size:1.1rem; font-weight:600; color:var(--text-main);">
        {% if user.first_name or user.last_name %}
          {{ user.first_name or "" }} {{ user.last_name or "" }}
        {% else %}
          {{ user.email }}
        {% endif %}
      </div>
      <div style="font-size:0.9rem; color:var(--text-muted); margin-top:2px;">Dashboard ¬∑ id={{ user.id }}</div>
      <div style="font-size:0.8rem; color:#9ca3af; margin-top:2px;">
        {% if user.location %}{{ user.location }}{% else %}Localisation non renseign√©e{% endif %}
      </div>
    </div>
  </div>

  <div style="display:flex; gap:8px;"><!-- header actions removed, now in global nav --></div>
</div>

<!-- ========================================================= -->
<!-- Profil coureur + bloc activit√©s (desktop only) -->
<!-- ========================================================= -->
<div class="dashboard-grid" style="position:relative; z-index:0;">

  <div class="card">
    <h2 style="font-size:1rem; font-weight:600; margin-bottom:7px;">üèÉ Profil coureur</h2>
    <p class="muted" style="margin-top:0; font-size:0.85rem;">
      Voir ton profil cardio √ó pente √ó VAM √ó cadence √ó allure.
    </p>

    <div style="margin-top:12px; text-align:right;">
      <a href="/ui/user/{{ user.id }}/runner-profile"
        style="
            display:inline-block;
            padding:10px 16px;
            background:var(--grad-accent);
            color:white;
            text-decoration:none;
            border-radius:4px;
            font-weight:600;
            box-shadow:0 6px 16px rgba(37,99,235,.25);
            transition:filter .15s ease;
        "
        onmouseover="this.style.filter='brightness(1.05)'"
        onmouseout="this.style.filter='none'">
        üìà Voir le profil coureur
      </a>
    </div>
  </div>

<!-- Bloc activit√©s (desktop uniquement) -->
<div class="mobile-hide-dashboard">
  <div class="card">
      <div id="anchor-vam" style="position:relative; top:-80px;"></div>

      <h2 style="font-size:1rem; font-weight:600; margin-bottom:6px;">üèÉ Activit√©s enregistr√©es</h2>

      {% if activities %}
        <p class="muted" style="margin-top:0; font-size:0.85rem;">
          Choisis une activit√© pour afficher les d√©tails, les courbes et le trac√© GPS.
        </p>

        <label style="margin-bottom:4px;">Activit√© :</label>
        <select id="activitySelect" style="min-width: 100%; max-width:100%;">
          {% for a in activities %}
            <option value="{{ a.id }}">{{ a.label }}</option>
          {% endfor %}
        </select>

        <div style="margin-top:10px; display:flex; justify-content:flex-end; gap:8px;">
          <button type="button" onclick="
            const sel = document.getElementById('activitySelect');
            const id = sel.value;
            if (id) window.location.href = `/ui/user/{{ user.id }}/activity/${id}`;
          ">
            Voir cette activit√©
          </button>
        </div>

      {% else %}
        <p class="muted" style="margin-top:8px;">Aucune activit√© enregistr√©e pour cet utilisateur pour le moment.</p>
        <p class="muted" style="margin-top:4px; font-size:0.85rem;">
          Utilise le bouton ‚Äúüì• Import Strava‚Äù pour r√©cup√©rer ta premi√®re activit√©.
        </p>
      {% endif %}
    </div>
  </div>
</div>


<!-- ================== DERNI√àRES ACTIVIT√âS (split map | VAM) ================== -->
<div class="dashboard-activities-grid">
{% for a in last_activities %}
  <div class="card"
     style="
       position:relative;
       overflow:visible;
       border:2px solid {{ a.level_color }};
       border-radius:6px;
     ">

    {% if a.level %}
      <!-- Badge niveau losange -->
      <div style="
        position:absolute;
        top:-10px;
        right:10px;
        display:flex;
        flex-direction:column;
        align-items:center;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      ">
        <div style="position:relative; width:75px; height:60px;">
          <!-- Contour blanc + ombre -->
          <div style="
            position:absolute;
            inset:0;
            clip-path: polygon(50% 0, 92% 40%, 70% 100%, 30% 100%, 8% 40%);
            background:#ffffff;
            box-shadow:0 4px 12px rgba(15,23,42,0.35);
            border-radius:2px;
          "></div>

          <!-- Int√©rieur color√© -->
            <div style="
                position:absolute;
                inset:3px;
                clip-path: polygon(50% 0, 92% 40%, 70% 100%, 30% 100%, 8% 40%);
                background: {{ a.level_color or '#6b7280' }};
                display:flex;
                flex-direction:column;
                align-items:center;
                justify-content:center;
                color:#ffffff;
                font-weight:700;
                text-transform:uppercase;

                /* üëâ Tu peux ajuster ici le texte du losang */
                padding-top:10px;
                padding-bottom:4px;
                padding-left:4px;
                padding-right:4px;
            ">
            <div style="font-size:0.55rem; letter-spacing:0.06em; opacity:0.9;">
              Niveau
            </div>
            <div style="font-size:1.05rem; line-height:1; margin-top:2px;">
              {{ a.level }}
            </div>
          </div>
        </div>

        <!-- Label sortie sous le losange -->
        <div style="
          margin-top:4px;
          font-size:0.65rem;
          text-transform:uppercase;
          letter-spacing:0.06em;
          color:#6b7280;
        ">
          Sortie
        </div>
      </div>
    {% endif %}

    <h3 style="margin:0;">
      <a href="/ui/user/{{ user.id }}/activity/{{ a.id }}">
        {{ (a.name or ('Activit√© #' ~ a.id))|truncate(60, True, '‚Ä¶') }}
      </a>
    </h3>
    <p class="muted" style="margin:4px 0 12px;">
      {{ a.date_str }} ¬∑ {{ a.dist_km }} km ¬∑ D+ {{ a.dplus }} m ¬∑
      Dur√©e {{ (a.duration_sec // 3600)|int }}h{{ ((a.duration_sec % 3600) // 60)|int }} ¬∑
      {% if a.tir_percent is not none %}TIR {{ a.tir_percent|round(0) }}%{% else %}TIR n/a{% endif %}
    </p>

    <div style="display:grid; grid-template-columns: minmax(0, 2fr) minmax(0, 1fr); gap:36px;">
      <!-- Carte √† gauche -->
      <div id="map-{{ a.id }}" style="height: 240px; border:1px solid #eee; border-radius:2px;"></div>

      <!-- ‚õ∞Ô∏è VAM de l‚Äôactivit√© -->
      <div style="margin-top:12px;">
        <h4 style="margin:0 0 6px 0;">‚õ∞Ô∏è VAM de l‚Äôactivit√©</h4>
        <p class="muted" style="margin:0 0 10px 0; font-size:0.85rem;">
          Vitesse Ascensionnelle Maximale (VAM) : meilleur rythme vertical moyen
          atteint sur une fen√™tre glissante de 5, 15 et 30 minutes.
        </p>

        <div style="display:grid; grid-template-columns: 1fr auto; row-gap:4px;">
          <div>5 min</div>
          <div style="text-align:right;">
            {% if a.vam_5 is not none %}
              {{ a.vam_5|round(0)|int }} m/hr
            {% else %} n/a {% endif %}
          </div>

          <div>15 min</div>
          <div style="text-align:right;">
            {% if a.vam_15 is not none %}
              {{ a.vam_15|round(0)|int }} m/hr
            {% else %} n/a {% endif %}
          </div>

          <div>30 min</div>
          <div style="text-align:right;">
            {% if a.vam_30 is not none %}
              {{ a.vam_30|round(0)|int }} m/hr
            {% else %} n/a {% endif %}
          </div>
        </div>
      </div>
    </div>

    <script>
      (function(){
        const pts = {{ a.gps|tojson }};
        if (pts && pts.length > 1 && window.L) {
          const map = L.map('map-{{ a.id }}', { zoomControl: false });
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
          }).addTo(map);
          const poly = L.polyline(pts, { weight: 3 }).addTo(map);
          map.fitBounds(poly.getBounds(), { padding: [20, 20] });
        }
      })();
    </script>
  </div>
{% endfor %}
</div>

<script>
  try {
    const dbg = {{ debug_js|safe }};
    console.log("Dashboard data:", dbg);
  } catch (e) {}
</script>

{% endblock %}
