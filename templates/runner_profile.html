{% extends "base.html" %}
{% block title %}Profil coureur ¬∑ {{ user.first_name or user.email }}{% endblock %}

{% block extra_head %}
<style>
  .runner-layout {
    display:grid;
    grid-template-columns:210px minmax(0,1fr);
    gap:16px;
    align-items:flex-start;
  }
  .runner-sidebar a {
    display:block;
    padding:8px 10px;
    border-radius:4px;
    text-decoration:none;
    margin-bottom:4px;
  }
  .runner-section {
    display:none;
  }
  .runner-section.is-active {
    display:block;
  }
  @media (max-width: 900px) {
    .runner-layout {
      grid-template-columns:1fr;
    }
    .runner-sidebar {
      display:none;
    }
    .runner-section {
      display:block !important;
      margin-bottom:16px;
    }
  }

  @media (min-width: 901px) {
    .runner-section {
      display:none;
    }
    .runner-section.is-active {
      display:block;
    }
  }
</style>
{% endblock %}

{% block content %}

<!-- ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó -->
<!--   üßç Header utilisateur + actions  -->
<!-- ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù -->
<div style="
  display:flex; align-items:center; justify-content:space-between;
  padding:16px 0 12px; border-bottom:1px solid var(--border-soft);
  margin-bottom:16px;
">
  <div style="display:flex; align-items:center; gap:14px;">

    {% if user.profile_image_url %}
    <div style="position:relative; width:70px; height:90px; flex-shrink:0;">
      <div style="
        position:absolute; inset:0; border-radius:50% / 58%;
        background: radial-gradient(circle at 30% 30%, #f7e7b0, #d4b469, #a07c36),
                    linear-gradient(145deg, rgba(255,255,255,0.5), rgba(0,0,0,0.3));
        background-blend-mode:overlay;
        box-shadow: inset 0 1px 2px rgba(255,255,255,0.7),
                    inset 0 -2px 4px rgba(0,0,0,0.35),
                    0 4px 10px rgba(0,0,0,0.35);
        padding:4px;
      "></div>
      <div style="
        position:absolute; top:4px; left:4px;
        width:calc(100% - 8px); height:calc(100% - 8px);
        border-radius:50% / 58%; overflow:hidden; background:#fff;
      ">
        <img src="{{ user.profile_image_url }}" style="width:100%;height:100%;object-fit:cover;">
      </div>
    </div>
    {% else %}
    <div style="position:relative; width:70px; height:90px; flex-shrink:0;">
      <div style="
        position:absolute; inset:0; border-radius:50% / 58%;
        background: radial-gradient(circle at 30% 30%, #f7e7b0, #d4b469, #a07c36),
                    linear-gradient(145deg, rgba(255,255,255,0.5), rgba(0,0,0,0.3));
        background-blend-mode:overlay;
        box-shadow: inset 0 1px 2px rgba(255,255,255,0.7),
                    inset 0 -2px 4px rgba(0,0,0,0.35),
                    0 4px 10px rgba(0,0,0,0.35);
        padding:4px;
      "></div>
      <div style="
        position:absolute; top:4px; left:4px;
        width:calc(100% - 8px); height:calc(100% - 8px);
        border-radius:50% / 58%;
        display:flex; align-items:center; justify-content:center;
        background:#fff; color:#111827; font-weight:700; font-size:1.3rem;
      ">
        {% if user.first_name %}
          {{ user.first_name[0]|upper }}
        {% else %}
          {{ user.email[0]|upper }}
        {% endif %}
      </div>
    </div>
    {% endif %}

    <div>
      <div style="font-size:1.1rem; font-weight:600;">
        {% if user.first_name or user.last_name %}
          {{ user.first_name or "" }} {{ user.last_name or "" }}
        {% else %}
          {{ user.email }}
        {% endif %}
      </div>
      <div class="muted" style="margin-top:2px;">Profil coureur ¬∑ id={{ user.id }}</div>
    </div>
  </div>

  <div style="display:flex; gap:10px;">
    <!-- Retour dashboard -->
    <a href="/ui/user/{{ user.id }}"
       style="display:inline-flex; align-items:center; gap:6px;
              padding:10px 16px; font-size:.95rem; font-weight:600; border-radius:2px;
              border:1px solid #cbd5e1; background:#ffffff; color:var(--text-main);
              text-decoration:none; box-shadow:0 3px 10px rgba(2,6,23,.05);
              transition:filter .15s ease, transform .06s ease;"
       onmouseover="this.style.background='#f8fafc'"
       onmouseout="this.style.background='#ffffff'">
      ‚¨ÖÔ∏è Dashboard
    </a>
  </div>
</div>

<!-- ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó -->
<!--      üéØ En-t√™te profil coureur -->
<!-- ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù -->
<div class="card" style="padding:14px; margin-bottom:14px;">
  <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
    <div>
      <h2 style="margin:0 0 4px 0; font-size:1.05rem; font-weight:600;">
        Profil coureur ‚Äì {{ sport }}
      </h2>
      <p class="muted" style="margin:0; font-size:0.85rem;">
        Choisis un onglet : D+ max, VAM, allure, cadence, fatigue ou glyc√©mie.
      </p>
    </div>

    <form method="get"
          action="{{ request.url.path }}"
          style="display:flex; gap:8px; align-items:center; font-size:0.85rem;">

      <input type="hidden" name="sport" value="{{ sport }}">
      <input type="hidden" name="tab" value="{{ tab }}">
      <input type="hidden" name="hr_zone_fatigue" value="{{ hr_zone_fatigue }}">

      <label for="period" style="white-space:nowrap;">P√©riode :</label>
      <select id="period" name="period"
              onchange="this.form.submit()"
              style="padding:4px 6px; border-radius:4px; border:1px solid #d1d5db;">
        <option value="all" {% if period == 'all' %}selected{% endif %}>
          Tout l‚Äôhistorique
        </option>
        <option value="last_12_months" {% if period == 'last_12_months' %}selected{% endif %}>
          12 derniers mois
        </option>
      </select>
    </form>
  </div>
</div>

<!-- ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó -->
<!--   ‚¨ÖÔ∏è Menu lat√©ral / contenu     -->
<!-- ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù -->
<div class="runner-layout">

  <!-- üß≠ Colonne gauche : menu onglets -->
  <aside class="card runner-sidebar" style="padding:12px; font-size:0.9rem;">
    <div style="font-weight:600; font-size:0.85rem; margin-bottom:8px;
                text-transform:uppercase; color:#6b7280;">
      Profil coureur
    </div>

    {% set base_url = request.url.path %}

    <!-- Onglet D+ -->
    <a href="{{ base_url }}?sport={{ sport }}&period={{ period }}&tab=ascent&hr_zone_fatigue={{ hr_zone_fatigue }}"
       style="
         display:block; padding:8px 10px; border-radius:4px;
         text-decoration:none; margin-bottom:4px;
         {% if tab == 'ascent' %}
           background:#0f172a; color:#f9fafb; font-weight:600;
         {% else %}
           color:#111827;
         {% endif %}
       ">
      D+ max (fen√™tres)
    </a>

    <!-- Onglet VAM -->
    <a href="{{ base_url }}?sport={{ sport }}&period={{ period }}&tab=vam&hr_zone_fatigue={{ hr_zone_fatigue }}"
       style="
         display:block; padding:8px 10px; border-radius:4px;
         text-decoration:none; margin-bottom:4px;
         {% if tab == 'vam' %}
           background:#0f172a; color:#f9fafb; font-weight:600;
         {% else %}
           color:#111827;
         {% endif %}
       ">
      VAM par pente √ó cardio
    </a>

    <!-- Onglet Allure -->
    <a href="{{ base_url }}?sport={{ sport }}&period={{ period }}&tab=pace&hr_zone_fatigue={{ hr_zone_fatigue }}"
       style="
         display:block; padding:8px 10px; border-radius:4px;
         text-decoration:none; margin-bottom:4px;
         {% if tab == 'pace' %}
           background:#0f172a; color:#f9fafb; font-weight:600;
         {% else %}
           color:#111827;
         {% endif %}
       ">
      Allure par pente √ó cardio
    </a>

    <!-- Onglet Cadence -->
    <a href="{{ base_url }}?sport={{ sport }}&period={{ period }}&tab=cadence&hr_zone_fatigue={{ hr_zone_fatigue }}"
       style="
         display:block; padding:8px 10px; border-radius:4px;
         text-decoration:none; margin-bottom:4px;
         {% if tab == 'cadence' %}
           background:#0f172a; color:#f9fafb; font-weight:600;
         {% else %}
           color:#111827;
         {% endif %}
       ">
      Cadence par pente √ó cardio
    </a>

    <!-- Onglet Fatigue / dur√©e -->
    <a href="{{ base_url }}?sport={{ sport }}&period={{ period }}&tab=fatigue&hr_zone_fatigue={{ hr_zone_fatigue }}"
       style="
         display:block; padding:8px 10px; border-radius:4px;
         text-decoration:none; margin-bottom:4px;
         {% if tab == 'fatigue' %}
           background:#0f172a; color:#f9fafb; font-weight:600;
         {% else %}
           color:#111827;
         {% endif %}
       ">
      Fatigue / dur√©e de course
    </a>

    <!-- Onglet Glyc√©mie -->
    <a href="{{ base_url }}?sport={{ sport }}&period={{ period }}&tab=glucose&hr_zone_fatigue={{ hr_zone_fatigue }}"
       style="
         display:block; padding:8px 10px; border-radius:4px;
         text-decoration:none;
         {% if tab == 'glucose' %}
           background:#0f172a; color:#f9fafb; font-weight:600;
         {% else %}
           color:#111827;
         {% endif %}
       ">
      Glyc√©mie (temps dans la zone)
    </a>
  </aside>

  <!-- üß© Colonne droite : contenu -->
  <main>

    <div class="card runner-section {% if tab == 'ascent' %}is-active{% endif %}" style="padding:14px;" data-section="ascent">
        <h3 style="margin:0 0 6px 0; font-size:0.95rem;">Meilleurs D+ par fen√™tre glissante</h3>
        <p class="muted" style="margin:0 0 12px 0; font-size:0.8rem;">
          On parcourt toutes les activit√©s pour trouver l‚Äôheure, les 2h, 5h, 10h et 24h o√π tu as
          grimp√© le plus de d√©nivel√© positif (plut√¥t qu‚Äôune simple activit√© enti√®re).
        </p>

        <div style="display:grid; gap:12px; grid-template-columns:repeat(auto-fit, minmax(240px, 1fr));">
          {% for window in best_dplus_windows %}
            <div style="border:1px solid #e5e7eb; border-radius:6px; padding:12px; background:#fdfdfd;">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                <strong>{{ window.label }}</strong>
                <span class="muted" style="font-size:0.75rem;">{{ (window.seconds/3600)|round(0)|int }}h max</span>
              </div>

              {% if window.gain_m and window.gain_m > 0 %}
                <div style="font-size:1.4rem; font-weight:700; color:#065f46;">
                  +{{ window.gain_m|round(0)|int }} m
                </div>
                <div class="muted" style="font-size:0.8rem;">
                  {% if window.gain_per_hour %}
                    soit {{ window.gain_per_hour|round(0)|int }} m/h
                  {% else %}
                    ‚Äì
                  {% endif %}
                </div>
                <div class="muted" style="font-size:0.78rem;">
                  D- : -{{ window.loss_m|round(0)|int }} m ¬∑ Distance ~ {{ window.distance_km|round(1) }} km
                </div>

                <div style="margin-top:10px; font-size:0.8rem; line-height:1.4;">
                  <div>Dur√©e couverte :
                    {% if window.duration_sec %}
                      {{ (window.duration_sec/3600)|round(2) }} h
                    {% else %}
                      ‚Äì
                    {% endif %}
                  </div>
                  {% if window.activity_id %}
                    <div>
                      Activit√© :
                      <a href="/ui/user/{{ user.id }}/activity/{{ window.activity_id }}"
                         style="color:#2563eb; text-decoration:none;">
                        {{ window.activity_name or ('Activit√© #' ~ window.activity_id) }}
                      </a>
                    </div>
                    <div>
                      Fen√™tre :
                      {% if window.start_datetime and window.end_datetime %}
                        {{ window.start_datetime.strftime('%d/%m %H:%M') }} ‚Üí {{ window.end_datetime.strftime('%H:%M') }}
                      {% else %}
                        ‚Äì
                      {% endif %}
                    </div>
                  {% endif %}
                </div>
              {% else %}
                <p class="muted" style="margin:0; font-size:0.8rem;">
                  Pas encore assez de segments avec altitude pour cette fen√™tre.
                </p>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </div>

    <div class="card runner-section {% if tab == 'vam' %}is-active{% endif %}" style="padding:14px;" data-section="vam">
        {% if profile.zones and profile.zones|length > 0 %}
          <h3 style="margin:0 0 10px 0; font-size:0.95rem;">
            VAM (m/h) par % de pente et zone cardio
          </h3>
          <p class="muted" style="margin:0 0 10px 0; font-size:0.8rem;">
            Ici on ne regarde que les <strong>pentes positives</strong> (mont√©es).
          </p>

          <table style="width:100%; border-collapse:collapse; font-size:0.8rem;">
            <thead>
              <tr style="border-bottom:1px solid #e5e7eb;">
                <th style="text-align:left; padding:4px 2px;">Pente</th>
                {% for z in hr_zones %}
                  <th style="text-align:right; padding:4px 2px;">
                    {{ z }}<br>
                    <span style="font-weight:400; font-size:0.7rem;">VAM (m/h)</span>
                  </th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for slope_id, slope_label in slopes_order %}
                {% if not slope_id.startswith("Sneg") %} {# ‚ùå exclut pentes n√©gatives #}
                  <tr style="border-bottom:1px solid #f3f4f6;">
                    <td style="padding:4px 2px;">{{ slope_label }}</td>

                    {% for z in hr_zones %}
                      {% set zone = profile.zones.get(z) %}
                      {% if zone %}
                        {% set cell = zone.get(slope_id) %}
                      {% else %}
                        {% set cell = None %}
                      {% endif %}

                      <td style="text-align:right; padding:4px 2px;">
                        {% if cell and cell.avg_vam_m_per_h %}
                          {{ cell.avg_vam_m_per_h|round(0)|int }}
                        {% else %}
                          ‚Äì
                        {% endif %}
                      </td>
                    {% endfor %}
                  </tr>
                {% endif %}
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="muted" style="margin:0;">
            Aucune donn√©e d‚Äôagr√©gats trouv√©e pour ce profil (sport={{ sport }}, p√©riode={{ period }}).
          </p>
        {% endif %}
      </div>

    <div class="card runner-section {% if tab == 'pace' %}is-active{% endif %}" style="padding:14px;" data-section="pace">
        {% if profile.zones and profile.zones|length > 0 %}
          <h3 style="margin:0 0 10px 0; font-size:0.95rem;">
            Allure moyenne (min/km) par % de pente et zone cardio
          </h3>
          <p class="muted" style="margin:0 0 10px 0; font-size:0.8rem;">
            On inclut ici mont√©es <strong>et descentes</strong> pour voir comment tu g√®res
            toutes les pentes.
          </p>

          <table style="width:100%; border-collapse:collapse; font-size:0.8rem;">
            <thead>
              <tr style="border-bottom:1px solid #e5e7eb;">
                <th style="text-align:left; padding:4px 2px;">Pente</th>
                {% for z in hr_zones %}
                  <th style="text-align:right; padding:4px 2px;">
                    {{ z }}<br>
                    <span style="font-weight:400; font-size:0.7rem;">Allure (min/km)</span>
                  </th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for slope_id, slope_label in slopes_order %}
                <tr style="border-bottom:1px solid #f3f4f6;">
                  <td style="padding:4px 2px;">{{ slope_label }}</td>

                  {% for z in hr_zones %}
                    {% set zone = profile.zones.get(z) %}
                    {% if zone %}
                      {% set cell = zone.get(slope_id) %}
                    {% else %}
                      {% set cell = None %}
                    {% endif %}

                    <td style="text-align:right; padding:4px 2px;">
                      {% if cell and cell.avg_pace_s_per_km %}
                        {% set pace_sec = cell.avg_pace_s_per_km|round(0)|int %}
                        {% set pace_min = pace_sec // 60 %}
                        {% set pace_rem = pace_sec % 60 %}
                        {{ pace_min }}'{{ "%02d"|format(pace_rem) }}
                      {% else %}
                        ‚Äì
                      {% endif %}
                    </td>
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="muted" style="margin:0;">
            Aucune donn√©e d‚Äôagr√©gats trouv√©e pour ce profil (sport={{ sport }}, p√©riode={{ period }}).
          </p>
        {% endif %}
      </div>

    <div class="card runner-section {% if tab == 'cadence' %}is-active{% endif %}" style="padding:14px;" data-section="cadence">
        {% if profile.zones and profile.zones|length > 0 %}
          <h3 style="margin:0 0 10px 0; font-size:0.95rem;">
            Cadence de pas (pas/min) par % de pente et zone cardio
          </h3>
          <p class="muted" style="margin:0 0 10px 0; font-size:0.8rem;">
            √áa permet de voir √† quelles pentes tu marches, trottines ou cours.
          </p>

          <table style="width:100%; border-collapse:collapse; font-size:0.8rem;">
            <thead>
              <tr style="border-bottom:1px solid #e5e7eb;">
                <th style="text-align:left; padding:4px 2px;">Pente</th>
                {% for z in hr_zones %}
                  <th style="text-align:right; padding:4px 2px;">
                    {{ z }}<br>
                    <span style="font-weight:400; font-size:0.7rem;">Cadence (pas/min)</span>
                  </th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for slope_id, slope_label in slopes_order %}
                <tr style="border-bottom:1px solid #f3f4f6;">
                  <td style="padding:4px 2px;">{{ slope_label }}</td>

                  {% for z in hr_zones %}
                    {% set zone = profile.zones.get(z) %}
                    {% if zone %}
                      {% set cell = zone.get(slope_id) %}
                    {% else %}
                      {% set cell = None %}
                    {% endif %}

                    <td style="text-align:right; padding:4px 2px;">
                      {% if cell and cell.avg_cadence_spm %}
                        {{ (cell.avg_cadence_spm * 2) | int }}
                      {% else %}
                        ‚Äì
                      {% endif %}
                    </td>
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="muted" style="margin:0;">
            Aucune donn√©e d‚Äôagr√©gats trouv√©e pour ce profil (sport={{ sport }}, p√©riode={{ period }}).
          </p>
        {% endif %}
      </div>

    <div class="card runner-section {% if tab == 'fatigue' %}is-active{% endif %}" style="padding:14px;" data-section="fatigue">

        {% if fatigue_profile and fatigue_profile.by_slope %}

          <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:8px;">
            <div>
              <h3 style="margin:0 0 4px 0; font-size:0.95rem;">
                D√©gradation de la performance selon la dur√©e de la sortie
              </h3>
              <p class="muted" style="margin:0; font-size:0.8rem;">
                {% if fatigue_profile.hr_zone %}
                  Zone cardio analys√©e : <strong>{{ fatigue_profile.hr_zone }}</strong>.
                {% else %}
                  Toutes les zones cardiaques sont agr√©g√©es.
                {% endif %}
              </p>
            </div>

            <!-- üéõ Filtre zone cardio pour la fatigue -->
            <form method="get"
                  action="{{ request.url.path }}"
                  style="display:flex; gap:8px; align-items:center; font-size:0.8rem;">
              <input type="hidden" name="sport" value="{{ sport }}">
              <input type="hidden" name="period" value="{{ period }}">
              <input type="hidden" name="tab" value="fatigue">

              <label for="hr_zone_fatigue" style="white-space:nowrap;">Zone cardio :</label>
              <select id="hr_zone_fatigue"
                      name="hr_zone_fatigue"
                      onchange="this.form.submit()
                      "
                      style="padding:4px 6px; border-radius:4px; border:1px solid #d1d5db;">
                <option value="all" {% if hr_zone_fatigue == 'all' %}selected{% endif %}>
                  Toutes
                </option>
                {% for z in hr_zones %}
                  <option value="{{ z }}" {% if hr_zone_fatigue == z %}selected{% endif %}>
                    {{ z }}
                  </option>
                {% endfor %}
              </select>
            </form>
          </div>

          {% set buckets = fatigue_profile.buckets %}

          <table style="width:100%; border-collapse:collapse; font-size:0.8rem;">
            <thead>
              <tr style="border-bottom:1px solid #e5e7eb;">
                <th style="text-align:left; padding:4px 2px;">Pente</th>
                {% for b in buckets %}
                  <th style="text-align:right; padding:4px 2px;">
                    {{ b.label }}<br>
                    <span style="font-weight:400; font-size:0.7rem;">Allure /km</span>
                  </th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>

              {% for slope_id, slope_label in slopes_order %}
                {% set slope_stats = fatigue_profile.by_slope.get(slope_id) %}
                {% if slope_stats %}
                  <tr style="border-bottom:1px solid #f3f4f6;">
                    <td style="padding:4px 2px;">{{ slope_label }}</td>

                    {% for b in buckets %}
                      {% set bucket_id = b.id %}
                      {% set bucket_stats = slope_stats.get(bucket_id) %}

                      <td style="text-align:right; padding:4px 2px;">
                        {% if bucket_stats and bucket_stats.avg_pace_s_per_km %}

                          {% set pace_s = bucket_stats.avg_pace_s_per_km %}
                          {% set m = (pace_s // 60)|int %}
                          {% set s = (pace_s % 60)|int %}

                          <div style="font-weight:600;">
                            {{ "%d:%02d"|format(m, s) }} /km
                          </div>

                          {% set deg = bucket_stats.degradation_vs_short_pct %}
                          {% if deg is not none and bucket_id != 'short' %}
                            {% set sign = '+' if deg >= 0 else '' %}
                            <div style="font-size:0.7rem; color:#6b7280;">
                              {{ sign }}{{ deg|round(0)|int }}%
                            </div>
                          {% elif bucket_id == 'short' %}
                            <div style="font-size:0.7rem; color:#6b7280;">
                              R√©f√©rence
                            </div>
                          {% endif %}

                        {% else %}
                          <span style="opacity:0.3;">‚Äì</span>
                        {% endif %}
                      </td>

                    {% endfor %}
                  </tr>
                {% endif %}
              {% endfor %}

            </tbody>
          </table>

          <p class="muted" style="margin-top:10px; font-size:0.75rem;">
            Comment lire ce tableau ?
            <br>‚Ä¢ La colonne &lt;2h sert de r√©f√©rence : elle affiche l‚Äôallure moyenne sur les portions
            10‚Äì15&nbsp;% (ou autre pente) couvertes pendant des sorties courtes.
            <br>‚Ä¢ Les colonnes 2‚Äì5h, 5‚Äì10h, ‚â•10h montrent l‚Äôallure quand la sortie dure plus longtemps.
              En mode ¬´&nbsp;Toutes les zones&nbsp;¬ª, on additionne toutes les zones cardio d‚Äôune m√™me
              activit√© avant de d√©terminer le bucket. Quand tu filtres une zone (ex. Zone‚ÄØ3), on ne
              regarde que le temps pass√© dans cette zone.
            <br>‚Ä¢ La ligne grise indique la d√©gradation en % vs la colonne &lt;2h. Exemple : si tu es √†
            6:00/km sur les pentes 10‚Äì15&nbsp;% en &lt;2h mais √† 6:45/km sur les sorties 5‚Äì10h (+12&nbsp;%),
            tu sais que tu perds 12&nbsp;% de vitesse moyenne quand la dur√©e augmente dans ces
            conditions.
          </p>

        {% else %}
          <p class="muted" style="margin:0;">
            Pas encore assez de donn√©es par dur√©e pour calculer la d√©gradation.
          </p>
        {% endif %}

      </div>

    <div class="runner-section {% if tab == 'glucose' %}is-active{% endif %}" data-section="glucose">

      <div class="card" style="padding:14px;">
        <h3 style="margin:0 0 6px 0; font-size:0.95rem;">
          Temps pass√© dans chaque zone glyc√©mie
        </h3>
        <p class="muted" style="margin:0 0 12px 0; font-size:0.8rem;">
          Distribution calcul√©e sur les 24 derni√®res heures, 7 jours et 14 jours.
        </p>

        <div style="display:grid; gap:12px; grid-template-columns:repeat(auto-fit, minmax(260px, 1fr));">
          {% for summary in glucose_zone_summary %}
            <div style="border:1px solid #e5e7eb; border-radius:6px; padding:10px; background:#fdfdfd;">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                <strong style="font-size:0.9rem;">{{ summary.label }}</strong>
                <span class="muted" style="font-size:0.75rem;">Total : {{ summary.total_time_str }}</span>
              </div>
              <table style="width:100%; border-collapse:collapse; font-size:0.8rem;">
                <thead>
                  <tr style="border-bottom:1px solid #e5e7eb;">
                    <th style="text-align:left; padding:4px 2px;">Zone</th>
                    <th style="text-align:left; padding:4px 2px;">Plage</th>
                    <th style="text-align:right; padding:4px 2px;">Temps</th>
                    <th style="text-align:right; padding:4px 2px;">% </th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in summary.rows %}
                    <tr style="border-bottom:1px solid #f3f4f6;">
                      <td style="padding:4px 2px; font-weight:600;">{{ row.name }}</td>
                      <td style="padding:4px 2px; color:#6b7280;">{{ row.range }}</td>
                      <td style="padding:4px 2px; text-align:right;">{{ row.time_str }}</td>
                      <td style="padding:4px 2px; text-align:right;">{{ row.percent }}%</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
              <div style="margin-top:8px; font-size:0.85rem; font-weight:600; color:#065f46; background:#d1fae5; padding:6px 8px; border-radius:4px;">
                {% if summary.avg_mgdl %}
                  Glyc√©mie moyenne : {{ summary.avg_mgdl|round(0)|int }} mg/dL
                {% else %}
                  Glyc√©mie moyenne : ‚Äì
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>

        {% set periods_with_data = glucose_zone_summary | selectattr('has_data') | list %}
        {% if periods_with_data|length == 0 %}
          <p class="muted" style="margin-top:12px;">
            Aucune donn√©e glyc√©mie disponible sur ces p√©riodes pour l‚Äôinstant.
          </p>
        {% endif %}
      </div>

      <div class="card" style="padding:14px; margin-top:14px;">
        <h3 style="margin:0 0 6px 0; font-size:0.95rem;">
          Courbe glyc√©mie ‚Äì derni√®res 24 h
        </h3>
        <p class="muted" style="margin:0 0 12px 0; font-size:0.8rem;">
          Visualise l‚Äô√©volution d√©taill√©e point par point.
        </p>

        {% if glucose_chart_24h and glucose_chart_24h|length > 1 %}
          <div style="height:260px;">
            <canvas id="glucose24hChart" height="240"></canvas>
          </div>
        {% else %}
          <p class="muted" style="margin:0;">
            Pas assez de points r√©cents pour dessiner la courbe.
          </p>
        {% endif %}
      </div>

      {% if glucose_chart_24h and glucose_chart_24h|length > 1 %}
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
        <script>
          (function() {
            const rawPoints = {{ glucose_chart_24h | tojson | safe }};
            if (!rawPoints || rawPoints.length === 0) return;

            const series = rawPoints.map(pt => ({
              x: new Date(pt.ts),
              y: pt.mgdl,
            }));

            const ctx = document.getElementById('glucose24hChart').getContext('2d');

            new Chart(ctx, {
              type: 'line',
              data: {
                datasets: [{
                  label: 'Glyc√©mie (mg/dL)',
                  data: series,
                  borderColor: '#dc2626',
                  backgroundColor: 'rgba(220,38,38,0.12)',
                  tension: 0.2,
                  pointRadius: 0,
                  borderWidth: 2,
                  fill: true,
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                  legend: { display: false },
                  tooltip: {
                    callbacks: {
                      title: items => {
                        const point = items[0].raw;
                        return new Date(point.x).toLocaleString('fr-FR');
                      },
                      label: item => `${item.raw.y.toFixed(0)} mg/dL`,
                    }
                  }
                },
                scales: {
                  x: {
                    type: 'time',
                    time: {
                      unit: 'hour',
                      displayFormats: {
                        hour: 'HH:mm',
                      },
                    },
                    ticks: { maxTicksLimit: 8 },
                    grid: { display: false },
                  },
                  y: {
                    suggestedMin: 60,
                    suggestedMax: 220,
                    grid: { color: '#e5e7eb' },
                    title: {
                      display: true,
                      text: 'mg/dL',
                      color: '#6b7280',
                    },
                  }
                }
              }
            });
          })();
        </script>
      {% endif %}
    </div>

  </main>
</div>

{% endblock %}
