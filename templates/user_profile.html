{% extends "base.html" %}

{% block title %}Profil ¬∑ {{ user.email }}{% endblock %}

{% block extra_head %}
<style>
  .profile-layout {
    display:grid;
    grid-template-columns:minmax(0,2fr) minmax(0,1.4fr);
    gap:16px;
  }

  @media (max-width: 820px) {
    .profile-layout {
      grid-template-columns:1fr;
    }
  }
</style>
{% endblock %}

{% block content %}

<!-- ========================================================= -->
<!-- üßç En-t√™te style Strava avec avatar pentagone (version bleue) -->
<!-- ========================================================= -->
<div style="
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:16px 0 12px;
  border-bottom:1px solid var(--border-soft);
  margin-bottom:16px;
">
  <div style="display:flex; align-items:center; gap:14px;">
    <div>
      <div style="font-size:1.1rem; font-weight:600; color:var(--text-main);">
        {% if user.first_name or user.last_name %}
          {{ user.first_name or "" }} {{ user.last_name or "" }}
        {% else %}
          {{ user.email }}
        {% endif %}
      </div>
      <div style="font-size:0.9rem; color:var(--text-muted); margin-top:2px;">
        Profil utilisateur ¬∑ id={{ user.id }}
      </div>
    </div>
  </div>
</div>


<!-- ========================================================= -->
<!-- Layout √† deux colonnes : gauche = profil, droite = connexions -->
<!-- ========================================================= -->
<div class="profile-layout">
  <!-- ================== COLONNE GAUCHE : Profil ================== -->
  <div>
    <div class="card" style="padding:16px 18px;">
      <h2 style="font-size:1rem; font-weight:600; margin-bottom:4px;">Informations de profil</h2>
      <p class="muted" style="margin-top:0; font-size:0.85rem; color:#6b7280;">Modifie les informations de base et les donn√©es physiologiques.</p>

      <form method="post" action="/ui/user/{{ user.id }}/profile" enctype="multipart/form-data" style="margin-top: 10px;">

        <!-- Bloc identit√© -->
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 14px;">
          <div><label>Pr√©nom</label><input type="text" name="first_name" value="{{ user.first_name or '' }}"></div>
          <div><label>Nom</label><input type="text" name="last_name" value="{{ user.last_name or '' }}"></div>
          <div><label>Localisation</label><input type="text" name="location" value="{{ user.location or '' }}" placeholder="Ex: Aix-les-Bains"></div>
        </div>

        <hr style="margin:16px 0; border:none; border-top:1px solid #e5e7eb;">

        <!-- Bloc physiologie -->
        <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px;">
          <div>
            <label style="display:block; font-size:0.8rem; color:#4b5563; margin-bottom:2px;">Date de naissance</label>
            <input type="date" name="birthdate" value="{{ user.birthdate if user.birthdate is not none }}">
          </div>
          <div>
            <label style="display:block; font-size:0.8rem; color:#4b5563; margin-bottom:2px;">Sexe</label>
            <select name="sex">
              <option value="" {% if not user.sex %}selected{% endif %}>Non renseign√©</option>
              <option value="male" {% if user.sex == 'male' %}selected{% endif %}>Homme</option>
              <option value="female" {% if user.sex == 'female' %}selected{% endif %}>Femme</option>
              <option value="other" {% if user.sex == 'other' %}selected{% endif %}>Autre</option>
            </select>
          </div>
          <div>
            <label style="display:block; font-size:0.8rem; color:#4b5563; margin-bottom:2px;">FC max (bpm)</label>
            <input type="number" name="max_heartrate" min="80" max="230" value="{{ user.max_heartrate or '' }}" placeholder="Ex: 190">
          </div>
          <div>
            <label style="display:block; font-size:0.8rem; color:#4b5563; margin-bottom:2px;">Taille (cm)</label>
            <input type="number" step="0.1" name="height_cm" value="{{ user.height_cm or '' }}" placeholder="Ex: 175">
          </div>
          <div>
            <label style="display:block; font-size:0.8rem; color:#4b5563; margin-bottom:2px;">Poids (kg)</label>
            <input type="number" step="0.1" name="weight_kg" value="{{ user.weight_kg or '' }}" placeholder="Ex: 70.5">
          </div>
        </div>

        <div style="margin-top:12px;">
          <label style="display:flex; align-items:center; gap:6px; font-size:0.85rem; color:#374151;">
            <input type="checkbox" name="is_pro" value="1" {% if user.is_pro %}checked{% endif %}> Abonn√© √† la version Pro
          </label>
        </div>

        <!-- ========================================================= -->
        <!-- Pr√©f√©rences d‚Äôenrichissement Strava (dans le M√äME form) -->
        <!-- ========================================================= -->
        <div class="card" style="margin-top:16px; padding:12px 14px;">
          <h3 style="font-size:0.95rem; font-weight:600; margin:0 0 6px;">Description Strava automatique</h3>
          <p class="muted" style="margin:0 0 10px; font-size:0.85rem; color:#6b7280;">
            Active l‚Äôenrichissement automatique des activit√©s Strava : glyc√©mie, VAM, allure ou cadence seront ajout√©es
            selon le type de sortie.
          </p>

          <label style="display:flex; align-items:center; gap:8px;">
            <input type="checkbox" name="desc_enable_auto_block"
                   {% if auto_block_enabled %}checked{% endif %}>
            Publier automatiquement les stats Strava
          </label>
        </div>

        <div style="margin-top:16px; display:flex; justify-content:flex-end;">
          <button type="submit" style="padding:6px 16px;font-size:0.9rem;border-radius:4px;border:1px solid transparent;background:#0d6efd;color:#fff;">
            Enregistrer les modifications
          </button>
        </div>
      </form>

      <div class="card" style="margin-top:20px; padding:14px 16px;">
        <h3 style="font-size:1rem; font-weight:600; margin:0 0 6px;">üì§ Importer des activit√©s pass√©es</h3>
        <p class="muted" style="margin:0 0 10px; font-size:0.85rem;">
          Strava ne renvoie que les activit√©s cr√©√©es apr√®s ton inscription sur Strava Glucose. Pour compl√©ter ton historique,
          exporte un fichier GPX ou FIT depuis Strava, puis d√©pose-le ici pour lancer l‚Äôorchestrateur.
        </p>

        <div id="profile-dropzone"
          style="margin-top:12px;padding:24px;border:2px dashed #cbd5e1;border-radius:6px;text-align:center;color:#475569;cursor:pointer;transition:0.2s border-color ease;"
          ondragover="this.style.borderColor='var(--accent)'; event.preventDefault();"
          ondragleave="this.style.borderColor='#cbd5e1';"
          onclick="document.getElementById('profile-file-input').click();">
          üìÅ <strong>Clique ici pour choisir ton fichier</strong><br>
          <span style="font-size:0.8rem;">Formats accept√©s : GPX / FIT</span>
        </div>

        <input id="profile-file-input" type="file" accept=".gpx,.fit" style="display:none;"
          onchange="document.getElementById('profile-selected-file').textContent = this.files[0].name;">

        <p id="profile-selected-file" style="font-size:0.85rem; color:#444; margin-top:10px; min-height:18px;"></p>

        <div style="margin-top:12px; text-align:right;">
          <button type="button" onclick="startProfileImport({{ user.id }})"
            style="padding:10px 16px;background:var(--grad-accent);color:white;border:none;border-radius:4px;font-weight:600;box-shadow:0 6px 16px rgba(37,99,235,.25);cursor:pointer;">
            ‚öôÔ∏è Lancer l'orchestrateur
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ================== COLONNE DROITE : Connexions ================== -->
  <div>
    <div class="card" style="padding:16px 18px;">
      <h2 style="font-size:1rem; font-weight:600; margin-bottom:4px;">Connexions</h2>
      <p class="muted" style="margin-top:0; font-size:0.85rem; color:#6b7280;">Comptes reli√©s √† cet utilisateur.</p>

      <div style="display:flex; flex-direction:column; gap:16px; margin-top:10px;">
        <!-- ================= STRAVA ================= -->
        <div style="border:1px solid #e5e7eb; border-radius:4px; padding:10px 12px;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <div style="font-size:0.95rem; font-weight:600; color:#111827;">Strava</div>
              {% if has_strava %}
                <div style="font-size:0.85rem; color:#16a34a; margin-top:2px;">
                  ‚úÖ Connect√©
                  {% if strava_athlete_id %} ¬∑ Athlete ID <strong>{{ strava_athlete_id }}</strong>{% endif %}
                </div>
              {% else %}
                <div style="font-size:0.85rem; color:#dc2626; margin-top:2px;">‚ö†Ô∏è Non connect√©</div>
              {% endif %}
            </div>

            {% if has_strava %}
              <form method="post" action="/ui/user/{{ user.id }}/strava/disconnect">
                <button type="submit" style="padding:4px 10px;font-size:0.8rem;border-radius:4px;border:1px solid transparent;background:#0d6efd;color:#fff;">
                  D√©connecter
                </button>
              </form>
            {% else %}
              <a href="/auth/strava?user_id={{ user.id }}" style="padding:4px 10px;font-size:0.8rem;border-radius:4px;border:1px solid transparent;background:#0d6efd;color:#fff;text-decoration:none;">
                Connecter Strava
              </a>
            {% endif %}
          </div>
        </div>

        <div style="border-top:1px dashed #e5e7eb; margin-top:4px;"></div>
        <div>
          <div style="font-size:0.95rem; font-weight:600; color:#111827; margin-bottom:4px;">Capteurs de glyc√©mie</div>
          <p style="margin:0; font-size:0.8rem; color:#6b7280;">Un seul capteur de glyc√©mie peut √™tre connect√© √† la fois (LibreLinkUp ou Dexcom).</p>
        </div>

        <!-- ================= LIBRELINKUP ================= -->
        <div id="libre" style="border:1px solid #e5e7eb; border-radius:4px; padding:10px 12px;">
          <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px;">
            <div style="flex:1;">
              <div style="font-size:0.95rem; font-weight:600; color:#111827;">LibreLinkUp</div>

              {% if libre_status == "ok" %}
                <div style="margin-top:6px; padding:6px 8px; border-radius:4px; background:#dcfce7; color:#166534; font-size:0.8rem;">
                  ‚úÖ {{ libre_status_message or "Connexion LibreLinkUp v√©rifi√©e." }}
                </div>
              {% elif libre_status == "warn" %}
                <div style="margin-top:6px; padding:6px 8px; border-radius:4px; background:#fef3c7; color:#92400e; font-size:0.8rem;">
                  ‚ö†Ô∏è {{ libre_status_message or "Identifiants enregistr√©s, mais LibreLinkUp limite temporairement cet IP." }}
                </div>
              {% elif libre_status == "error" %}
                <div style="margin-top:6px; padding:6px 8px; border-radius:4px; background:#fee2e2; color:#991b1b; font-size:0.8rem;">
                  ‚ö†Ô∏è {{ libre_status_message or "Impossible de v√©rifier les identifiants LibreLinkUp." }}
                </div>
              {% endif %}

              {% if has_libre %}
                <div style="font-size:0.85rem; color:#16a34a; margin-top:2px;">
                  ‚úÖ Connect√© ¬∑ <strong>{{ libre_email }}</strong> ({{ libre_region }})
                </div>

                <details style="margin-top:8px;">
                  <summary style="cursor:pointer; font-size:0.85rem; color:#0d6efd;">Modifier les identifiants</summary>
                  <form method="post" action="/ui/user/{{ user.id }}/libre/credentials" style="margin-top:8px;">
                    <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:8px;">
                      <div><label style="display:block; font-size:0.8rem; color:#4b5563;">Email LibreLinkUp</label><input type="email" name="email" value="{{ libre_email or '' }}" required></div>
                      <div>
                        <label style="display:block; font-size:0.8rem; color:#4b5563;">Mot de passe</label>
                        <div style="position:relative;">
                          <input type="password" name="password" id="libre-password-edit" required style="padding-right:32px;">
                          <button type="button" onclick="togglePassword('libre-password-edit', this)" style="position:absolute;right:6px;top:50%;transform:translateY(-50%);border:none;background:transparent;cursor:pointer;font-size:0.9rem;">üëÅÔ∏è</button>
                        </div>
                      </div>
                      <div>
                        <label style="display:block; font-size:0.8rem; color:#4b5563;">R√©gion</label>
                        <select name="region">
                          <option value="fr" {% if libre_region == "fr" %}selected{% endif %}>France / Europe (fr)</option>
                          <option value="eu" {% if libre_region == "eu" %}selected{% endif %}>Europe (eu)</option>
                          <option value="us" {% if libre_region == "us" %}selected{% endif %}>USA (us)</option>
                          <option value="de" {% if libre_region == "de" %}selected{% endif %}>Allemagne (de)</option>
                          <option value="it" {% if libre_region == "it" %}selected{% endif %}>Italie (it)</option>
                        </select>
                      </div>
                    </div>
                    <button type="submit" style="margin-top:10px;padding:4px 12px;font-size:0.85rem;border-radius:4px;border:1px solid transparent;background:#0d6efd;color:#fff;">
                      Mettre √† jour LibreLinkUp
                    </button>
                  </form>
                </details>

              {% elif has_dexcom %}
                <div style="font-size:0.85rem; color:#9ca3af; margin-top:2px;">üîí LibreLinkUp d√©sactiv√© car Dexcom est d√©j√† connect√©.</div>
                <p style="margin-top:6px; font-size:0.8rem; color:#6b7280;">D√©connecte Dexcom si tu veux utiliser LibreLinkUp comme capteur.</p>

              {% else %}
                <div style="font-size:0.85rem; color:#dc2626; margin-top:2px;">‚ö†Ô∏è Aucun compte LibreLinkUp connect√©</div>
                <p style="margin-top:6px; font-size:0.85rem; color:#4b5563;">Renseigne ton compte LibreLinkUp pour r√©cup√©rer les donn√©es de glyc√©mie.</p>

                <form method="post" action="/ui/user/{{ user.id }}/libre/credentials" style="margin-top:8px;">
                  <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:8px;">
                    <div><label style="display:block; font-size:0.8rem; color:#4b5563;">Email LibreLinkUp</label><input type="email" name="email" value="{{ libre_email or '' }}" required></div>
                    <div>
                      <label style="display:block; font-size:0.8rem; color:#4b5563;">Mot de passe</label>
                      <div style="position:relative;">
                        <input type="password" name="password" id="libre-password-new" required style="padding-right:32px;">
                        <button type="button" onclick="togglePassword('libre-password-new', this)" style="position:absolute;right:6px;top:50%;transform:translateY(-50%);border:none;background:transparent;cursor:pointer;font-size:0.9rem;">üëÅÔ∏è</button>
                      </div>
                    </div>
                    <div>
                      <label style="display:block; font-size:0.8rem; color:#4b5563;">R√©gion</label>
                      <select name="region">
                        <option value="fr" {% if libre_region == "fr" %}selected{% endif %}>France / Europe (fr)</option>
                        <option value="eu" {% if libre_region == "eu" %}selected{% endif %}>Europe (eu)</option>
                        <option value="us" {% if libre_region == "us" %}selected{% endif %}>USA (us)</option>
                        <option value="de" {% if libre_region == "de" %}selected{% endif %}>Allemagne (de)</option>
                        <option value="it" {% if libre_region == "it" %}selected{% endif %}>Italie (it)</option>
                      </select>
                    </div>
                  </div>
                  <button type="submit" style="margin-top:10px;padding:4px 12px;font-size:0.85rem;border-radius:4px;border:1px solid transparent;background:#0d6efd;color:#fff;">
                    Connecter LibreLinkUp
                  </button>
                  <p class="muted" style="margin-top:4px; font-size:0.75rem; color:#9ca3af;">
                    Les identifiants sont stock√©s localement et utilis√©s uniquement pour interroger l'API LibreLinkUp.
                  </p>
                </form>
              {% endif %}
            </div>

            {% if has_libre %}
              <form method="post" action="/ui/user/{{ user.id }}/libre/disconnect">
                <button type="submit" style="padding:4px 10px;font-size:0.8rem;border-radius:4px;border:1px solid transparent;background:#0d6efd;color:#fff;">
                  D√©connecter
                </button>
              </form>
            {% endif %}
          </div>
        </div>

        <!-- ================= DEXCOM ================= -->
        <div id="dexcom" style="border:1px solid #e5e7eb; border-radius:4px; padding:10px 12px;">
          <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px;">
            <div style="flex:1;">
              <div style="font-size:0.95rem; font-weight:600; color:#111827;">Dexcom</div>

              {% if has_dexcom %}
                <div style="font-size:0.85rem; color:#16a34a; margin-top:2px;">‚úÖ Connect√© √† Dexcom</div>
                <p style="margin-top:6px; font-size:0.8rem; color:#4b5563;">Les tokens d'acc√®s Dexcom sont stock√©s localement pour r√©cup√©rer tes valeurs de glyc√©mie.</p>
              {% elif has_libre %}
                <div style="font-size:0.85rem; color:#9ca3af; margin-top:2px;">üîí Dexcom d√©sactiv√© car LibreLinkUp est d√©j√† connect√©.</div>
                <p style="margin-top:6px; font-size:0.8rem; color:#6b7280;">D√©connecte LibreLinkUp si tu veux utiliser Dexcom comme capteur.</p>
              {% else %}
                <div style="font-size:0.85rem; color:#dc2626; margin-top:2px;">‚ö†Ô∏è Aucun compte Dexcom connect√©</div>
                <p style="margin-top:6px; font-size:0.8rem; color:#4b5563;">Connecte ton compte Dexcom pour r√©cup√©rer les donn√©es CGM via l'API Dexcom.</p>
              {% endif %}

              <details style="margin-top:10px; font-size:0.8rem; color:#475569;">
                <summary style="cursor:pointer; list-style:none; display:flex; align-items:center; gap:6px;">
                  <span style="font-weight:600;">En savoir plus</span>
                  <span style="font-size:0.7rem; color:#94a3b8;">‚ñº</span>
                </summary>
                <div style="margin-top:8px; line-height:1.5;">
                  En vous connectant √† Dexcom, vous autorisez Strava Glucose √† acc√©der √† vos donn√©es de glyc√©mie via l‚ÄôAPI s√©curis√©e de Dexcom. Ces donn√©es servent uniquement √† :
                  <ul style="margin:8px 0 8px 18px; padding:0;">
                    <li>analyser vos s√©ances sportives,</li>
                    <li>fournir des retours √©ducatifs et des indicateurs de s√©curit√©,</li>
                    <li>mieux comprendre l‚Äôimpact de l‚Äôeffort sur votre glyc√©mie.</li>
                  </ul>
                  Votre autorisation est volontaire et peut √™tre retir√©e √† tout moment dans les param√®tres du compte. Aucune donn√©e Dexcom n‚Äôest vendue, partag√©e ou rendue publique.
                </div>
              </details>
            </div>

            <div style="display:flex; flex-direction:column; gap:6px; align-items:flex-end;">
              {% if has_dexcom %}
                <form method="post" action="/ui/user/{{ user.id }}/dexcom/disconnect">
                  <button type="submit" style="padding:4px 10px;font-size:0.8rem;border-radius:4px;border:1px solid transparent;background:#0d6efd;color:#fff;">
                    D√©connecter
                  </button>
                </form>
                <a href="/auth/dexcom?user_id={{ user.id }}" style="padding:4px 10px;font-size:0.8rem;border-radius:4px;border:1px solid transparent;background:#0d6efd;color:#fff;text-decoration:none;">
                  Reconnecter Dexcom
                </a>
              {% elif not has_libre %}
                <a href="/auth/dexcom?user_id={{ user.id }}" style="padding:4px 10px;font-size:0.8rem;border-radius:4px;border:1px solid transparent;background:#0d6efd;color:#fff;text-decoration:none;">
                  Connecter Dexcom
                </a>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- (‚ö†Ô∏è plus de formulaire s√©par√© "Enregistrer les pr√©f√©rences") -->

      </div>
    </div>
  </div>
</div>

<div class="card" style="margin-top:16px; border:1px solid #fee2e2; background:#fff; padding:18px;">
  <h3 style="margin-top:0; color:#b91c1c;">Supprimer mon compte</h3>
  <p style="margin:0 0 12px 0; font-size:0.9rem; color:#4b5563;">
    Cette action efface d√©finitivement ton profil, tes activit√©s, tokens et donn√©es de glyc√©mie. Impossible de revenir en arri√®re.
  </p>
  <form method="post" action="/ui/user/{{ user.id }}/delete-account"
        onsubmit="return confirm('Supprimer d√©finitivement ton compte et toutes les donn√©es associ√©es ?');">
    <button type="submit" style="background:#0d6efd; color:#fff; border:1px solid transparent; padding:8px 16px; border-radius:4px;">
      Supprimer mon compte
    </button>
  </form>
</div>

<script>
  function togglePassword(inputId, btn) {
    const input = document.getElementById(inputId);
    if (!input) return;
    const isPassword = input.type === 'password';
    input.type = isPassword ? 'text' : 'password';
    btn.textContent = isPassword ? 'üôà' : 'üëÅÔ∏è';
  }

  function startProfileImport(userId) {
    const fileInput = document.getElementById('profile-file-input');
    if (!fileInput || !fileInput.files.length) {
      alert("Merci de s√©lectionner un fichier GPX ou FIT.");
      return;
    }

    const formData = new FormData();
    formData.append("file", fileInput.files[0]);

    fetch(`/api/users/${userId}/import-activity`, {
      method: "POST",
      body: formData,
    })
      .then((r) => r.json())
      .then(() => {
        alert("Import lanc√© ! L'orchestrateur va traiter l'activit√©.");
      })
      .catch((err) => {
        console.error(err);
        alert("Erreur lors de l'import.");
      });
  }
</script>

{% endblock %}
